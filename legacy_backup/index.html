<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENBEB MARKET | ERP Finance 360춿</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.23.9/babel.min.js"></script>

    <!-- SheetJS (Librer칤a para Exportar Excel Profesional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Transiciones suaves */
        .transition-all-300 { transition: all 0.3s ease-in-out; }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, updateDoc, doc, deleteDoc, getDoc, orderBy, where, Timestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA_S4K3VpAVHU4KW1T1vIsA7tu9icrGaks",
            authDomain: "gestion-negocio-pro.firebaseapp.com",
            projectId: "gestion-negocio-pro",
            storageBucket: "gestion-negocio-pro.firebasestorage.app",
            messagingSenderId: "827486290467",
            appId: "1:827486290467:web:3df14c777fc93ab592a796"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'enbeb-erp-v1';

        // --- ICONS ---
        const IconBase = ({ size = 20, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Dashboard: (p) => <IconBase {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            Cart: (p) => <IconBase {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconBase>,
            Truck: (p) => <IconBase {...p}><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></IconBase>,
            Users: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Package: (p) => <IconBase {...p}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconBase>,
            TrendingUp: (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            Alert: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>,
            Dollar: (p) => <IconBase {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            BarChart: (p) => <IconBase {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconBase>,
            Check: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Clock: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            ArrowUp: (p) => <IconBase {...p}><path d="M7 7h10v10"/><path d="M7 17 17 7"/></IconBase>,
            ArrowDown: (p) => <IconBase {...p}><path d="m7 7 10 10"/><path d="M17 7v10H7"/></IconBase>,
            Trash: (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            Edit: (p) => <IconBase {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>,
            Phone: (p) => <IconBase {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>,
            Mail: (p) => <IconBase {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></IconBase>,
            Building: (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></IconBase>,
            ShoppingBag: (p) => <IconBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Eye: (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            History: (p) => <IconBase {...p}><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            Clipboard: (p) => <IconBase {...p}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>,
            Wallet: (p) => <IconBase {...p}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>,
            UserCheck: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></IconBase>,
            Percent: (p) => <IconBase {...p}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            Archive: (p) => <IconBase {...p}><polyline points="21 8 21 21 3 21 3 8"/><rect width="22" height="5" x="1" y="3"/><line x1="10" x2="14" y1="12" y2="12"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            Activity: (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>,
            Target: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>
        };

        // --- UTILITIES ---
        const calculatePaymentDate = (invoiceDateStr) => {
            if (!invoiceDateStr) return '';
            const [y, m, d] = invoiceDateStr.split('-').map(Number);
            const invoiceDate = new Date(y, m - 1, d); 
            const creditDate = new Date(invoiceDate);
            creditDate.setDate(invoiceDate.getDate() + 10);
            const dayOfWeek = creditDate.getDay(); 
            const daysUntilFriday = (5 - dayOfWeek + 7) % 7;
            const paymentDate = new Date(creditDate);
            paymentDate.setDate(creditDate.getDate() + daysUntilFriday);
            const py = paymentDate.getFullYear();
            const pm = String(paymentDate.getMonth() + 1).padStart(2, '0');
            const pd = String(paymentDate.getDate()).padStart(2, '0');
            return `${py}-${pm}-${pd}`;
        };

        const formatCurrency = (amount) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(amount);
        
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
            return `${parseInt(day)} ${months[parseInt(month)-1]} ${year}`;
        };

        const exportToCSV = (data, filename) => {
            const csvContent = "data:text/csv;charset=utf-8," 
                + data.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- GLOBAL NOTIFICATION COMPONENT ---
        const Notification = ({ message, type, onClose }) => {
            React.useEffect(() => {
                const timer = setTimeout(onClose, 3000); 
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-500';
            const icon = type === 'success' ? <Icons.Check size={20}/> : <Icons.Alert size={20}/>;

            return (
                <div className={`fixed top-4 right-4 z-[9999] ${bgColor} text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 animate-slide-in`}>
                    {icon}
                    <span className="font-medium">{message}</span>
                    <button onClick={onClose} className="ml-4 opacity-70 hover:opacity-100"><Icons.X size={16}/></button>
                </div>
            );
        };

        // --- CHART COMPONENT ---
        const SimpleLineChart = ({ data, height = 200 }) => {
            if (!data || data.length === 0) return <div className="h-full flex items-center justify-center text-gray-400 text-sm">Insuficientes datos</div>;
            const maxVal = Math.max(...data.map(d => d.monto)) || 100;
            const padding = 20;
            const width = 1000; 
            const chartH = height; 
            const points = data.map((d, i) => {
                const x = (i / (data.length - 1 || 1)) * (width - padding * 2) + padding;
                const y = chartH - ((d.monto / maxVal) * (chartH - padding * 2)) - padding;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-full" style={{ height: height }}>
                    <svg viewBox={`0 0 ${width} ${chartH}`} className="w-full h-full overflow-visible">
                        <line x1={padding} y1={padding} x2={width-padding} y2={padding} stroke="#e5e7eb" strokeDasharray="4"/>
                        <line x1={padding} y1={chartH/2} x2={width-padding} y2={chartH/2} stroke="#e5e7eb" strokeDasharray="4"/>
                        <line x1={padding} y1={chartH-padding} x2={width-padding} y2={chartH-padding} stroke="#e5e7eb" strokeDasharray="4"/>
                        <polyline fill="none" stroke="#2563eb" strokeWidth="3" points={points} />
                        {data.map((d, i) => {
                            const x = (i / (data.length - 1 || 1)) * (width - padding * 2) + padding;
                            const y = chartH - ((d.monto / maxVal) * (chartH - padding * 2)) - padding;
                            return (
                                <g key={i} className="group">
                                    <circle cx={x} cy={y} r="5" fill="#fff" stroke="#2563eb" strokeWidth="2" />
                                    <rect x={x-40} y={y-35} width="80" height="25" rx="4" fill="#1f2937" className="opacity-0 group-hover:opacity-100 transition-opacity" />
                                    <text x={x} y={y-18} textAnchor="middle" fill="#fff" fontSize="12" className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">{formatCurrency(d.monto)}</text>
                                </g>
                            )
                        })}
                    </svg>
                    <div className="flex justify-between text-xs text-gray-400 mt-2 px-2">
                        <span>{data[0]?.date}</span>
                        <span>{data[data.length-1]?.date}</span>
                    </div>
                </div>
            );
        };

        // --- AUTH COMPONENT ---
        const Login = () => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isRegistering, setIsRegistering] = React.useState(false);
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError("Error de autenticaci칩n. Verifique credenciales.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-cyan-500 mb-2">ENBEB VISION</h1>
                            <p className="text-gray-500 text-sm">Sistema de Gesti칩n Empresarial</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-5">
                            <input type="email" required className="w-full p-2 border rounded" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} />
                            <input type="password" required className="w-full p-2 border rounded" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} />
                            {error && <div className="text-red-500 text-sm">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">{loading ? 'Cargando...' : (isRegistering ? 'Crear Cuenta' : 'Iniciar Sesi칩n')}</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- MODULES ---

        const Dashboard = ({ products, sales, purchases, expenses }) => { 
            const now = new Date();
            const [selectedMonth, setSelectedMonth] = React.useState(now.getMonth());
            const [selectedYear, setSelectedYear] = React.useState(now.getFullYear());
            const [utilityView, setUtilityView] = React.useState('monthly');

            const months = [ "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre" ];
            const years = [2024, 2025, 2026];

            const monthlySales = sales.filter(s => {
                const [y, m, d] = s.date.split('-').map(Number);
                return y === parseInt(selectedYear) && (m - 1) === parseInt(selectedMonth);
            });

            const annualSales = sales.filter(s => {
                const [y, m, d] = s.date.split('-').map(Number);
                return y === parseInt(selectedYear);
            });

            const pendingSales = sales.filter(s => s.status === 'Pendiente');
            const pendingPurchases = purchases.filter(p => (p.status || 'Pendiente') === 'Pendiente');
            
            const totalAccountsPayableNet = pendingPurchases.reduce((acc, curr) => acc + (curr.total || 0), 0);
            const totalAccountsPayable = totalAccountsPayableNet * 1.18; 

            // --- INVENTARIO VALORIZADO (SOLO ACTIVOS) ---
            const activeProducts = products.filter(p => p.status !== 'inactive');
            const totalInventoryValue = activeProducts.reduce((acc, prod) => acc + ((prod.cost || 0) * (prod.stock || 0)), 0);
            const totalInventoryItems = activeProducts.reduce((acc, prod) => acc + (prod.stock || 0), 0);
            
            // Filtro de Gastos
            const monthlyExpenses = expenses.filter(ex => {
                const [y, m, d] = ex.date.split('-').map(Number);
                return y === parseInt(selectedYear) && (m - 1) === parseInt(selectedMonth);
            });
            const annualExpenses = expenses.filter(ex => {
                const [y, m, d] = ex.date.split('-').map(Number);
                return y === parseInt(selectedYear);
            });

            const calculateFinancials = (salesList, expenseList = []) => {
                let totalRevenue = 0; 
                let totalNet = 0;      
                let totalCost = 0;

                salesList.forEach(sale => {
                    totalRevenue += (sale.total || 0);
                    const saleNet = sale.subtotal || (sale.total / 1.18);
                    totalNet += saleNet;
                    if (sale.items) {
                        const saleCost = sale.items.reduce((acc, item) => {
                            let unitCost = item.cost;
                            if (!unitCost || unitCost === 0) {
                                const currentProd = products.find(p => p.id === item.productId);
                                if (currentProd) unitCost = currentProd.cost;
                            }
                            return acc + ((unitCost || 0) * item.qty);
                        }, 0);
                        totalCost += saleCost;
                    }
                });

                const profit = totalNet - totalCost;
                const margin = totalNet > 0 ? (profit / totalNet) * 100 : 0;
                
                return { totalRevenue, totalNet, totalCost, profit, margin, count: salesList.length };
            };

            const metricsMonthly = calculateFinancials(monthlySales, monthlyExpenses);
            const metricsPending = calculateFinancials(pendingSales, []);
            
            const annualSalesForMetrics = sales.filter(s => {
                const [y, m, d] = s.date.split('-').map(Number);
                return y === parseInt(selectedYear);
            });
            const metricsAnnual = calculateFinancials(annualSalesForMetrics, annualExpenses);

            const displayedProfitMetrics = utilityView === 'monthly' ? metricsMonthly : metricsAnnual;

            // --- KPIs AVANZADOS PROFESIONALES ---
            
            // 1. COMPARATIVA TICKET PROMEDIO (MoM - Month over Month)
            const prevMonthDate = new Date(selectedYear, selectedMonth - 1, 1);
            const prevMonthIndex = prevMonthDate.getMonth();
            const prevYearIndex = prevMonthDate.getFullYear();

            const prevMonthSales = sales.filter(s => {
                const [y, m, d] = s.date.split('-').map(Number);
                return y === prevYearIndex && (m - 1) === prevMonthIndex;
            });
            const prevMetrics = calculateFinancials(prevMonthSales, []);
            
            const averageTicket = metricsMonthly.count > 0 ? metricsMonthly.totalRevenue / metricsMonthly.count : 0;
            const prevAverageTicket = prevMetrics.count > 0 ? prevMetrics.totalRevenue / prevMetrics.count : 0;
            const ticketGrowth = prevAverageTicket > 0 ? ((averageTicket - prevAverageTicket) / prevAverageTicket) * 100 : 0;

            // 2. PUNTO DE EQUILIBRIO CON BARRA DE PROGRESO
            const totalMonthlyFixedExpenses = monthlyExpenses.reduce((acc, curr) => acc + curr.amount, 0);
            const marginRatio = metricsMonthly.margin / 100;
            const breakEvenPoint = marginRatio > 0 ? totalMonthlyFixedExpenses / marginRatio : 0;
            const breakEvenCoverage = breakEvenPoint > 0 ? Math.min(100, (metricsMonthly.totalNet / breakEvenPoint) * 100) : 0;

            // 3. D칈AS DE INVENTARIO (DIO) - SEM츼FORO DE EFICIENCIA
            const dio = metricsMonthly.totalCost > 0 ? (totalInventoryValue / metricsMonthly.totalCost) * 30 : 0;
            let dioStatus = { label: 'N/A', color: 'text-gray-400', bg: 'bg-gray-100' };
            if (metricsMonthly.totalCost > 0) {
                if (dio <= 30) dioStatus = { label: 'Eficiente (R치pido)', color: 'text-green-600', bg: 'bg-green-100', barColor: 'bg-green-500' };
                else if (dio <= 60) dioStatus = { label: 'Regular', color: 'text-yellow-600', bg: 'bg-yellow-100', barColor: 'bg-yellow-500' };
                else dioStatus = { label: 'Lento (Exceso Stock)', color: 'text-red-600', bg: 'bg-red-100', barColor: 'bg-red-500' };
            }

            const salesTrendData = monthlySales.sort((a, b) => new Date(a.date) - new Date(b.date)).map(s => ({ date: formatDate(s.date), monto: s.total }));
            
            const productPerformance = {};
            monthlySales.forEach(sale => {
                if(sale.items) {
                    sale.items.forEach(item => {
                        if (!productPerformance[item.productId]) {
                            productPerformance[item.productId] = { name: item.productName, profit: 0, revenue: 0 };
                        }
                        const itemNetRevenue = item.subtotal || (item.price * item.qty);
                        let unitCost = item.cost;
                        if (!unitCost || unitCost === 0) {
                            const currentProd = products.find(p => p.id === item.productId);
                            if (currentProd) unitCost = currentProd.cost;
                        }
                        const itemTotalCost = (unitCost || 0) * item.qty;
                        productPerformance[item.productId].revenue += itemNetRevenue;
                        productPerformance[item.productId].profit += (itemNetRevenue - itemTotalCost);
                    });
                }
            });
            const topProducts = Object.values(productPerformance).sort((a, b) => b.profit - a.profit).slice(0, 5);


            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-col sm:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h2 className="text-xl font-bold text-gray-800 mb-2 sm:mb-0">Tablero Financiero</h2>
                        <div className="flex gap-2">
                            <select className="border p-2 rounded-lg text-sm bg-gray-50 outline-none" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}>{months.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                            <select className="border p-2 rounded-lg text-sm bg-gray-50 outline-none" value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)}>{years.map(y => <option key={y} value={y}>{y}</option>)}</select>
                        </div>
                    </div>
                    
                    {/* --- KPI SECTION PRINCIPAL --- */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Ventas {months[selectedMonth]} (Inc. IGV)</p><h3 className="text-2xl font-bold text-gray-800">{formatCurrency(metricsMonthly.totalRevenue)}</h3><p className="text-xs text-gray-400 mt-1">{metricsMonthly.count} operaciones</p></div>
                            <div className="p-3 bg-blue-50 rounded-full text-blue-600"><Icons.Dollar size={24} /></div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between">
                            <div><p className="text-xs text-gray-500 font-bold uppercase tracking-wider">Por Cobrar (Cartera)</p><h3 className="text-2xl font-bold text-orange-600">{formatCurrency(metricsPending.totalRevenue)}</h3><p className="text-xs text-orange-400 mt-1">Flujo pendiente total</p></div>
                            <div className="p-3 bg-orange-50 rounded-full text-orange-600"><Icons.Clock size={24} /></div>
                        </div>

                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between relative overflow-hidden">
                            <div className="flex justify-between items-start mb-2 z-10">
                                <div>
                                    <p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">
                                        {utilityView === 'monthly' ? `Utilidad Bruta ${months[selectedMonth]}` : `Utilidad Bruta Anual ${selectedYear}`}
                                    </p>
                                    <h3 className={`text-2xl font-bold ${utilityView === 'monthly' ? 'text-green-600' : 'text-blue-600'}`}>
                                        {formatCurrency(displayedProfitMetrics.profit)}
                                    </h3>
                                </div>
                                <div className={`p-2 rounded-full ${utilityView === 'monthly' ? 'bg-green-50 text-green-600' : 'bg-blue-50 text-blue-600'}`}>
                                    <Icons.TrendingUp size={20} />
                                </div>
                            </div>
                            
                            <div className="flex bg-gray-100 p-1 rounded-lg mb-2 z-10">
                                <button onClick={() => setUtilityView('monthly')} className={`flex-1 text-[10px] py-1 rounded-md font-bold transition-all ${utilityView === 'monthly' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Mes Actual</button>
                                <button onClick={() => setUtilityView('annual')} className={`flex-1 text-[10px] py-1 rounded-md font-bold transition-all ${utilityView === 'annual' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>Anual</button>
                            </div>

                            <div className="text-[10px] text-gray-400 space-y-0.5 z-10 border-t pt-2 border-gray-50">
                                <div className="flex justify-between"><span>Venta Neta:</span> <span className="font-medium">{formatCurrency(displayedProfitMetrics.totalNet)}</span></div>
                                <div className="flex justify-between text-red-300"><span>- Costos:</span> <span>{formatCurrency(displayedProfitMetrics.totalCost)}</span></div>
                                <div className="flex justify-between font-bold text-gray-500 mt-1"><span>Margen:</span> <span>{displayedProfitMetrics.margin.toFixed(1)}%</span></div>
                            </div>
                        </div>
                    </div>

                    {/* --- INDICADORES OPERATIVOS PROFESIONALES (KPIs) --- */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* 1. TICKET PROMEDIO CON TENDENCIA */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <p className="text-[10px] text-indigo-500 font-bold uppercase tracking-wider">Ticket Promedio</p>
                                    <h3 className="text-xl font-bold text-gray-800">{formatCurrency(averageTicket)}</h3>
                                </div>
                                <div className="p-2 bg-indigo-50 rounded-full text-indigo-600"><Icons.Cart size={18}/></div>
                            </div>
                            <div className="flex items-center mt-2 border-t pt-2 border-dashed border-gray-100">
                                {Math.abs(ticketGrowth) > 0 ? (
                                    <span className={`text-xs font-bold flex items-center ${ticketGrowth >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                                        {ticketGrowth >= 0 ? <Icons.ArrowUp size={12}/> : <Icons.ArrowDown size={12}/>} 
                                        {Math.abs(ticketGrowth).toFixed(1)}% 
                                    </span>
                                ) : <span className="text-xs text-gray-400">Sin cambios</span>}
                                <span className="text-[10px] text-gray-400 ml-1">vs mes anterior ({formatCurrency(prevAverageTicket)})</span>
                            </div>
                        </div>

                        {/* 2. D칈AS DE INVENTARIO (DIO) CON SEM츼FORO */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-purple-100 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <p className="text-[10px] text-purple-500 font-bold uppercase tracking-wider">D칤as de Inventario (DIO)</p>
                                    <h3 className="text-xl font-bold text-gray-800">
                                        {metricsMonthly.totalCost > 0 ? Math.round(dio) : '-'} <span className="text-sm font-normal text-gray-500">d칤as</span>
                                    </h3>
                                </div>
                                <div className="p-2 bg-purple-50 rounded-full text-purple-600"><Icons.Activity size={18}/></div>
                            </div>
                            <div className="mt-2">
                                <div className="flex justify-between text-[10px] mb-1">
                                    <span className="text-gray-400">Rotaci칩n:</span>
                                    <span className={`font-bold ${dioStatus.color}`}>{dioStatus.label}</span>
                                </div>
                                <div className="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                    <div className={`h-full ${dioStatus.barColor || 'bg-gray-300'}`} style={{width: `${Math.min(100, (dio/90)*100)}%`}}></div>
                                </div>
                            </div>
                        </div>

                        {/* 3. PUNTO DE EQUILIBRIO CON BARRA DE PROGRESO */}
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-emerald-100 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <p className="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">Punto Equilibrio (Mes)</p>
                                    <h3 className="text-xl font-bold text-gray-800">{formatCurrency(breakEvenPoint)}</h3>
                                </div>
                                <div className="p-2 bg-emerald-50 rounded-full text-emerald-600"><Icons.Target size={18}/></div>
                            </div>
                            <div className="mt-2">
                                <div className="flex justify-between text-[10px] mb-1">
                                    <span className="text-gray-400">Progreso Cobertura:</span>
                                    <span className={`font-bold ${breakEvenCoverage >= 100 ? 'text-green-600' : 'text-orange-500'}`}>{breakEvenCoverage.toFixed(0)}%</span>
                                </div>
                                <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden relative">
                                    <div className={`h-full absolute top-0 left-0 transition-all duration-500 ${breakEvenCoverage >= 100 ? 'bg-green-500' : 'bg-orange-400'}`} style={{width: `${breakEvenCoverage}%`}}></div>
                                    {/* Marca del 100% */}
                                    <div className="absolute top-0 bottom-0 w-0.5 bg-white z-10" style={{left: `${Math.min(100, (metricsMonthly.totalNet / breakEvenPoint)*100)}%`}}></div>
                                </div>
                                <p className="text-[9px] text-gray-400 mt-1 text-right">
                                    {breakEvenCoverage >= 100 ? '춰Costos fijos cubiertos! 游' : `Faltan ${formatCurrency(Math.max(0, breakEvenPoint - metricsMonthly.totalNet))} para cubrir costos`}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 flex flex-col justify-between relative overflow-hidden group hover:shadow-md transition-shadow">
                            <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Icons.Package size={60} className="text-indigo-600"/></div>
                            <div>
                                <p className="text-xs text-indigo-500 font-bold uppercase tracking-wider flex items-center gap-1">Inventario Valorizado <span className="bg-indigo-100 text-[9px] px-1.5 py-0.5 rounded-full text-indigo-700">Activo</span></p>
                                <h3 className="text-2xl font-bold text-indigo-700 mt-1">{formatCurrency(totalInventoryValue)}</h3>
                                <div className="mt-2 border-t border-indigo-50 pt-2">
                                    <div className="flex justify-between text-xs text-indigo-400">
                                        <span>Total 칈tems:</span>
                                        <span className="font-bold">{totalInventoryItems} un.</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-indigo-400 mt-1">
                                        <span>Referencias:</span>
                                        <span className="font-bold">{activeProducts.length} SKUs</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-5 rounded-xl shadow-sm border border-red-50 flex flex-col justify-between group hover:shadow-md transition-shadow">
                            <div>
                                <p className="text-xs text-red-500 font-bold uppercase tracking-wider">Cuentas Por Pagar</p>
                                <h3 className="text-2xl font-bold text-red-600 mt-1">{formatCurrency(totalAccountsPayable)}</h3>
                                <p className="text-xs text-red-400 mt-2">{pendingPurchases.length} facturas pendientes (Inc. IGV)</p>
                            </div>
                            <div className="mt-4 flex justify-end"><div className="p-2 bg-red-100 rounded-full text-red-600"><Icons.Alert size={20} /></div></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h4 className="text-lg font-semibold mb-4 text-gray-800">Tendencia Ventas: {months[selectedMonth]}</h4>
                            <div className="h-64 w-full px-2">
                                {salesTrendData.length > 0 ? <SimpleLineChart data={salesTrendData} height={240} /> : <div className="h-full flex flex-col items-center justify-center text-gray-400"><Icons.BarChart size={32} className="mb-2 opacity-50"/><p className="text-sm">No hay datos para este periodo.</p></div>}
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h4 className="text-lg font-semibold mb-4 text-gray-800">Top Productos (Rentabilidad del Mes)</h4>
                            <div className="space-y-3">
                                {topProducts.length > 0 ? (
                                    topProducts.map((p, idx) => (
                                        <div key={idx} className="flex justify-between items-center p-3 hover:bg-gray-50 rounded border-b last:border-0 border-gray-100">
                                            <div className="flex items-center">
                                                <span className="w-6 h-6 flex items-center justify-center bg-indigo-100 text-indigo-700 font-bold text-xs rounded-full mr-3">{idx + 1}</span>
                                                <span className="text-sm font-medium text-gray-700">{p.name}</span>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-sm font-bold text-gray-800">{formatCurrency(p.profit)}</div>
                                                <div className="text-xs text-gray-400">Ventas: {formatCurrency(p.revenue)}</div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-gray-500 text-sm text-center py-8">Sin datos de rentabilidad a칰n.</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Expenses = ({ db, userId, expenses, showNotification }) => {
            const [desc, setDesc] = React.useState('');
            const [amount, setAmount] = React.useState('');
            const [category, setCategory] = React.useState('Servicios');
            const [date, setDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [isSubmitting, setIsSubmitting] = React.useState(false);

            const addExpense = async () => {
                if(!desc || !amount) return;
                setIsSubmitting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'expenses'), { 
                        description: desc, 
                        amount: parseFloat(amount), 
                        category, 
                        date, 
                        createdAt: Timestamp.now() 
                    });
                    setDesc(''); setAmount(''); 
                    showNotification("Gasto registrado.", 'success');
                } catch(e) { showNotification("Error al guardar.", 'error'); } 
                finally { setIsSubmitting(false); }
            };

            const deleteExpense = async (id) => {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'expenses', id)); showNotification("Gasto eliminado.", 'success'); } 
                catch(e) { showNotification("Error al eliminar.", 'error'); }
            };

            const categories = ["Alquiler", "Servicios (Luz/Agua/Net)", "Planilla", "Mantenimiento", "Movilidad", "Otros"];

            return (
                <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                        <h3 className="font-bold mb-4 flex items-center text-gray-800"><Icons.Wallet size={20} className="mr-2 text-red-600"/> Registrar Gasto (OpEx)</h3>
                        <div className="space-y-3">
                            <input type="date" className="w-full border p-2 rounded text-sm" value={date} onChange={e=>setDate(e.target.value)} />
                            <select className="w-full border p-2 rounded text-sm" value={category} onChange={e=>setCategory(e.target.value)}>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
                            <input className="w-full border p-2 rounded text-sm" placeholder="Descripci칩n (Ej. Recibo Luz)" value={desc} onChange={e=>setDesc(e.target.value)} />
                            <div className="relative">
                                <span className="absolute left-3 top-2 text-gray-500 text-sm">S/</span>
                                <input type="number" className="w-full border p-2 pl-8 rounded text-sm" placeholder="Monto" value={amount} onChange={e=>setAmount(e.target.value)} />
                            </div>
                            <button onClick={addExpense} disabled={isSubmitting} className="w-full bg-red-600 text-white py-2 rounded text-sm font-bold hover:bg-red-700 transition disabled:opacity-50">{isSubmitting ? 'Guardando...' : 'Registrar Gasto'}</button>
                        </div>
                    </div>
                    <div className="col-span-1 md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between"><span>Historial de Gastos</span><span className="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">{expenses.length}</span></div>
                        <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white text-gray-500 border-b"><tr><th className="p-3">Fecha</th><th className="p-3">Categor칤a</th><th className="p-3">Descripci칩n</th><th className="p-3 text-right">Monto</th><th className="p-3"></th></tr></thead><tbody className="divide-y divide-gray-100">{expenses.sort((a,b) => new Date(b.date)-new Date(a.date)).map(ex => (<tr key={ex.id} className="hover:bg-gray-50"><td className="p-3 text-xs text-gray-500">{formatDate(ex.date)}</td><td className="p-3"><span className="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600">{ex.category}</span></td><td className="p-3 font-medium text-gray-700">{ex.description}</td><td className="p-3 text-right font-bold text-red-600">-{formatCurrency(ex.amount)}</td><td className="p-3 text-right"><button onClick={() => deleteExpense(ex.id)} className="text-gray-300 hover:text-red-500 transition"><Icons.Trash size={16}/></button></td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        };

        // --- M칍DULO REPORTES CON PANEL ---
        const Reports = ({ products, sales, purchases }) => {
            const [view, setView] = React.useState('dashboard'); // 'dashboard' | 'rotation' | 'receivables' | 'margins' | 'payables'
            const [reportYear, setReportYear] = React.useState(new Date().getFullYear());
            const [marginSortConfig, setMarginSortConfig] = React.useState({ key: 'profit', direction: 'desc' });
            const [repSortConfig, setRepSortConfig] = React.useState({ key: 'suggested', direction: 'desc' });
            
            const years = [2024, 2025, 2026];
            const months = [ "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre" ];

            // --- L칍GICA DE PROYECCI칍N DE DEMANDA ---
            const getReplenishmentData = (prod) => {
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                const recentSalesItems = sales
                    .filter(s => new Date(s.date) >= thirtyDaysAgo)
                    .flatMap(s => s.items || [])
                    .filter(i => i.productId === prod.id);
                
                const qtySoldLast30d = recentSalesItems.reduce((acc, item) => acc + item.qty, 0);
                const avgDailySale = qtySoldLast30d / 30; 
                
                const targetCoverageDays = 45; 
                const idealStock = Math.ceil(avgDailySale * targetCoverageDays);
                
                const replenishment = Math.max(0, idealStock - prod.stock);
                
                return {
                    sold30d: qtySoldLast30d,
                    dailyRate: avgDailySale,
                    ideal: idealStock,
                    suggested: replenishment,
                    status: replenishment > 0 ? 'reorder' : 'ok'
                };
            };

            const getRotationStatus = (prod) => {
                const prodSales = sales.flatMap(s => s.items || []).filter(i => i.productId === prod.id);
                if (prodSales.length === 0) return { label: "Sin Movimiento", color: "bg-gray-100 text-gray-500", score: 0 };
                
                const relevantSales = sales.filter(s => s.items && s.items.some(i => i.productId === prod.id)).sort((a,b) => new Date(b.date) - new Date(a.date));
                if (relevantSales.length === 0) return { label: "Sin Movimiento", color: "bg-gray-100 text-gray-500", score: 0 };

                const lastSaleDate = new Date(relevantSales[0].date);
                const daysSinceSale = Math.floor((new Date() - lastSaleDate) / (1000 * 60 * 60 * 24));

                if (daysSinceSale > 60) return { label: "Hueso (Cr칤tico)", color: "bg-red-100 text-red-700", score: 1 };
                if (daysSinceSale > 30) return { label: "Lento", color: "bg-orange-100 text-orange-700", score: 2 };
                
                const totalQty = prodSales.reduce((a,b) => a + b.qty, 0);
                if (totalQty > 50) return { label: "Estrella 游", color: "bg-yellow-100 text-yellow-800 border border-yellow-200", score: 5 };
                return { label: "Normal", color: "bg-green-100 text-green-700", score: 3 };
            };

            // --- SORTING HELPERS FOR REPLENISHMENT ---
            const requestRepSort = (key) => {
                let direction = 'asc';
                if (repSortConfig.key === key && repSortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setRepSortConfig({ key, direction });
            };

            const getRepSortIcon = (name) => {
                if (repSortConfig.key !== name) return <div className="w-3 h-3 ml-1 opacity-20"><Icons.ArrowDown size={12}/></div>;
                return repSortConfig.direction === 'asc' ? <Icons.ArrowUp size={12} className="ml-1"/> : <Icons.ArrowDown size={12} className="ml-1"/>;
            };

            const inventoryAnalysis = React.useMemo(() => {
                let items = products.map(p => ({
                    ...p, 
                    rotation: getRotationStatus(p),
                    replenishment: getReplenishmentData(p)
                }));

                // Apply Sorting
                items.sort((a, b) => {
                    let aVal, bVal;

                    if (repSortConfig.key === 'name') {
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                    } else if (repSortConfig.key === 'stock') {
                        aVal = a.stock;
                        bVal = b.stock;
                    } else if (['sold30d', 'dailyRate', 'suggested'].includes(repSortConfig.key)) {
                        aVal = a.replenishment[repSortConfig.key];
                        bVal = b.replenishment[repSortConfig.key];
                    } else if (repSortConfig.key === 'rotation') {
                        aVal = a.rotation.score;
                        bVal = b.rotation.score;
                    } else {
                        // Default fallback
                        aVal = a.replenishment.suggested;
                        bVal = b.replenishment.suggested;
                    }

                    if (aVal < bVal) return repSortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return repSortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                return items;
            }, [products, sales, repSortConfig]);

            // --- FUNCIONES DE ORDENAMIENTO (M츼RGENES) ---
            const requestMarginSort = (key) => {
                let direction = 'asc';
                if (marginSortConfig.key === key && marginSortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setMarginSortConfig({ key, direction });
            };

            const getMarginSortIcon = (name) => {
                if (marginSortConfig.key !== name) return <div className="w-3 h-3 ml-1 opacity-20"><Icons.ArrowDown size={12}/></div>;
                return marginSortConfig.direction === 'asc' ? <Icons.ArrowUp size={12} className="ml-1"/> : <Icons.ArrowDown size={12} className="ml-1"/>;
            };

            // --- AN츼LISIS DE CARTERA (DEUDA COBRO) ---
            const receivablesAnalysis = React.useMemo(() => {
                const pending = sales.filter(s => s.status === 'Pendiente');
                const totalPendingAmount = pending.reduce((acc, s) => acc + s.total, 0);

                const byClient = pending.reduce((acc, sale) => {
                    if (!acc[sale.clientId]) {
                        acc[sale.clientId] = {
                            id: sale.clientId,
                            name: sale.clientName,
                            count: 0,
                            total: 0,
                            oldestDue: sale.dueDate,
                            invoices: [] // NUEVO: Lista de ventas pendientes
                        };
                    }
                    acc[sale.clientId].count += 1;
                    acc[sale.clientId].total += sale.total;
                    
                    // NUEVO: Guardar detalle de la venta
                    acc[sale.clientId].invoices.push({
                        id: sale.id,
                        date: sale.date,
                        dueDate: sale.dueDate,
                        total: sale.total,
                        invoiceNo: sale.invoiceNo || 'Ticket' // Asumimos un campo si existiera
                    });

                    if (new Date(sale.dueDate) < new Date(acc[sale.clientId].oldestDue)) {
                        acc[sale.clientId].oldestDue = sale.dueDate;
                    }
                    return acc;
                }, {});

                return {
                    clients: Object.values(byClient).sort((a, b) => b.total - a.total),
                    grandTotal: totalPendingAmount
                };
            }, [sales]);

            // --- AN츼LISIS DE CUENTAS POR PAGAR (DEUDA PAGO) ---
            const payablesAnalysis = React.useMemo(() => {
                // Filtrar SOLO por estado 'Pendiente'. NO filtrar por a침o.
                const pending = purchases.filter(p => (p.status || 'Pendiente') === 'Pendiente');
                
                // Asumimos que la l칩gica de Purchases calcula el total base y el displayed es * 1.18.
                // Replicamos la l칩gica del componente Dashboard: totalAccountsPayable = net * 1.18
                const totalPendingAmount = pending.reduce((acc, p) => acc + ((p.total || 0) * 1.18), 0);

                const bySupplier = pending.reduce((acc, purchase) => {
                    if (!acc[purchase.supplierId]) {
                        acc[purchase.supplierId] = {
                            id: purchase.supplierId,
                            name: purchase.supplierName,
                            count: 0,
                            total: 0,
                            oldestDue: purchase.dueDate || purchase.date,
                            invoices: [] // NUEVO: Array para guardar el detalle de facturas
                        };
                    }
                    acc[purchase.supplierId].count += 1;
                    const gross = (purchase.total || 0) * 1.18;
                    acc[purchase.supplierId].total += gross;
                    
                    // NUEVO: Agregar detalle de factura
                    acc[purchase.supplierId].invoices.push({
                        id: purchase.id,
                        invoiceNo: purchase.invoiceNo || 'S/N',
                        date: purchase.date,
                        dueDate: purchase.dueDate || purchase.date,
                        total: gross
                    });

                    const currentDueDate = purchase.dueDate || purchase.date;
                    if (new Date(currentDueDate) < new Date(acc[purchase.supplierId].oldestDue)) {
                        acc[purchase.supplierId].oldestDue = currentDueDate;
                    }
                    return acc;
                }, {});

                return {
                    suppliers: Object.values(bySupplier).sort((a, b) => b.total - a.total),
                    grandTotal: totalPendingAmount
                };
            }, [purchases]);

            // Estados para los modales de detalle de deuda
            const [viewingSupplierDebt, setViewingSupplierDebt] = React.useState(null);
            const [viewingClientDebt, setViewingClientDebt] = React.useState(null);


            // --- AN츼LISIS DE M츼RGENES (MODIFICADO POR A칌O) ---
            const marginAnalysis = React.useMemo(() => {
                const productStats = {};
                
                const annualSales = sales.filter(s => {
                    if (!s.date) return false;
                    const saleYear = parseInt(s.date.split('-')[0]);
                    return saleYear === parseInt(reportYear);
                });

                annualSales.forEach(sale => {
                    (sale.items || []).forEach(item => {
                        if (!productStats[item.productId]) {
                            const currentProductInfo = products.find(p => p.id === item.productId);
                            
                            productStats[item.productId] = {
                                id: item.productId,
                                name: currentProductInfo ? currentProductInfo.name : item.productName, 
                                qty: 0,
                                revenue: 0,
                                cost: 0
                            };
                        }
                        
                        let unitCost = item.cost;
                        if (!unitCost || unitCost === 0) {
                            const currentProd = products.find(p => p.id === item.productId);
                            if (currentProd) unitCost = currentProd.cost;
                        }

                        const itemRevenue = item.subtotal || (item.price * item.qty);
                        const itemCost = (unitCost || 0) * item.qty;

                        productStats[item.productId].qty += item.qty;
                        productStats[item.productId].revenue += itemRevenue;
                        productStats[item.productId].cost += itemCost;
                    });
                });

                const result = Object.values(productStats).map(p => ({
                    ...p,
                    profit: p.revenue - p.cost,
                    margin: p.revenue > 0 ? ((p.revenue - p.cost) / p.revenue) * 100 : 0
                }));

                result.sort((a, b) => {
                    let aVal = a[marginSortConfig.key];
                    let bVal = b[marginSortConfig.key];

                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }

                    if (aVal < bVal) return marginSortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return marginSortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                return result;

            }, [sales, products, reportYear, marginSortConfig]); 

            // VISTA: PANEL DE CONTROL
            if (view === 'dashboard') {
                return (
                    <div className="animate-fade-in">
                        <h2 className="text-2xl font-bold text-gray-800 mb-6">Panel de Reportes</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <button 
                                onClick={() => setView('rotation')}
                                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-indigo-200 transition-all text-left group"
                            >
                                <div className="p-3 bg-indigo-50 text-indigo-600 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform">
                                    <Icons.FileText size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Reposici칩n Stock</h3>
                                <p className="text-sm text-gray-500 mt-2">Sugerencias de compra inteligentes.</p>
                            </button>
                            
                            <button 
                                onClick={() => setView('receivables')}
                                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-orange-200 transition-all text-left group"
                            >
                                <div className="p-3 bg-orange-50 text-orange-600 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform">
                                    <Icons.UserCheck size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Cuentas x Cobrar</h3>
                                <p className="text-sm text-gray-500 mt-2">Cartera de clientes y deuda.</p>
                            </button>

                             <button 
                                onClick={() => setView('payables')}
                                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-red-200 transition-all text-left group"
                            >
                                <div className="p-3 bg-red-50 text-red-600 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform">
                                    <Icons.Truck size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Cuentas x Pagar</h3>
                                <p className="text-sm text-gray-500 mt-2">Obligaciones con proveedores.</p>
                            </button>

                            <button 
                                onClick={() => setView('margins')}
                                className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md hover:border-green-200 transition-all text-left group"
                            >
                                <div className="p-3 bg-green-50 text-green-600 rounded-full w-fit mb-4 group-hover:scale-110 transition-transform">
                                    <Icons.Percent size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Rentabilidad</h3>
                                <p className="text-sm text-gray-500 mt-2">An치lisis de margen bruto anual.</p>
                            </button>
                        </div>
                    </div>
                );
            }

            // VISTA: M츼RGENES
            if (view === 'margins') {
                return (
                    <div className="animate-fade-in space-y-4">
                        <div className="flex justify-between items-center mb-2">
                            <button onClick={() => setView('dashboard')} className="flex items-center text-sm text-gray-500 hover:text-indigo-600 font-medium transition-colors">
                                 Volver al Panel
                            </button>
                            <div className="flex items-center gap-2">
                                <span className="text-sm font-bold text-gray-700">A침o:</span>
                                <select 
                                    className="border border-gray-300 rounded-lg p-1 text-sm focus:ring-2 focus:ring-green-500 outline-none bg-white"
                                    value={reportYear} 
                                    onChange={(e) => setReportYear(e.target.value)}
                                >
                                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                             <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.Percent size={20} className="mr-2 text-green-600"/> Rentabilidad por Producto ({reportYear})</h3>
                             <p className="text-sm text-gray-500 mb-6">Haz clic en los encabezados para ordenar la tabla.</p>

                             <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-gray-50 text-gray-600 border-b uppercase text-xs">
                                            <tr>
                                                <th className="p-3 cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestMarginSort('name')}><div className="flex items-center">Producto {getMarginSortIcon('name')}</div></th>
                                                <th className="p-3 text-center cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestMarginSort('qty')}><div className="flex items-center justify-center">Unidades {getMarginSortIcon('qty')}</div></th>
                                                <th className="p-3 text-right cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestMarginSort('revenue')}><div className="flex items-center justify-end">Venta (Neto) {getMarginSortIcon('revenue')}</div></th>
                                                <th className="p-3 text-right cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestMarginSort('cost')}><div className="flex items-center justify-end">Costo Total {getMarginSortIcon('cost')}</div></th>
                                                <th className="p-3 text-right bg-green-50 cursor-pointer hover:bg-green-100 transition select-none text-green-800" onClick={() => requestMarginSort('profit')}><div className="flex items-center justify-end">Utilidad Bruta {getMarginSortIcon('profit')}</div></th>
                                                <th className="p-3 text-center cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestMarginSort('margin')}><div className="flex items-center justify-center">% Margen {getMarginSortIcon('margin')}</div></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {marginAnalysis.length > 0 ? (
                                                marginAnalysis.map(p => (
                                                    <tr key={p.id} className="hover:bg-gray-50">
                                                        <td className="p-3 font-medium text-gray-800">{p.name}</td>
                                                        <td className="p-3 text-center">{p.qty}</td>
                                                        <td className="p-3 text-right">{formatCurrency(p.revenue)}</td>
                                                        <td className="p-3 text-right text-gray-500">{formatCurrency(p.cost)}</td>
                                                        <td className="p-3 text-right font-bold text-green-700 bg-green-50/30">{formatCurrency(p.profit)}</td>
                                                        <td className="p-3 text-center">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.margin > 40 ? 'bg-green-100 text-green-800' : p.margin > 20 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                                {p.margin.toFixed(1)}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="6" className="p-8 text-center text-gray-400 italic">No hay ventas registradas en el a침o {reportYear}.</td>
                                                </tr>
                                            )}
                                        </tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                );
            }

            // VISTA: CARTERA DE CLIENTES
            if (view === 'receivables') {
                return (
                    <div className="animate-fade-in space-y-4">
                        {/* --- MODAL DETALLE DE VENTAS POR COBRAR --- */}
                        {viewingClientDebt && (
                            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4" onClick={() => setViewingClientDebt(null)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <div>
                                            <h3 className="font-bold text-gray-800">Detalle por Cobrar</h3>
                                            <p className="text-xs text-gray-500">{viewingClientDebt.name}</p>
                                        </div>
                                        <button onClick={() => setViewingClientDebt(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button>
                                    </div>
                                    <div className="p-0 overflow-y-auto max-h-[60vh]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-xs uppercase text-gray-500 border-b sticky top-0">
                                                <tr><th className="p-3">Emisi칩n</th><th className="p-3 text-center">Vence</th><th className="p-3 text-right">Monto</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {viewingClientDebt.invoices.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).map((inv, i) => {
                                                    const today = new Date(); today.setHours(0,0,0,0);
                                                    const [y,m,d] = inv.dueDate.split('-').map(Number);
                                                    const dueD = new Date(y,m-1,d);
                                                    const isPastDue = dueD < today;
                                                    
                                                    return (
                                                        <tr key={i} className="hover:bg-gray-50">
                                                            <td className="p-3 text-gray-700 font-medium">
                                                                {formatDate(inv.date)}
                                                            </td>
                                                            <td className="p-3 text-center">
                                                                <div className={`text-xs font-medium ${isPastDue ? 'text-red-600' : 'text-blue-600'}`}>{formatDate(inv.dueDate)}</div>
                                                                {isPastDue && <div className="text-[9px] text-red-500 font-bold uppercase">Vencido</div>}
                                                            </td>
                                                            <td className="p-3 text-right font-bold text-gray-800">{formatCurrency(inv.total)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="p-3 bg-orange-50 border-t flex justify-between items-center">
                                        <span className="text-xs font-bold text-orange-800 uppercase">Total por Cobrar</span>
                                        <span className="font-bold text-orange-700 text-lg">{formatCurrency(viewingClientDebt.total)}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        <button onClick={() => setView('dashboard')} className="flex items-center text-sm text-gray-500 hover:text-indigo-600 font-medium transition-colors mb-2">
                             Volver al Panel
                        </button>
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                             <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h3 className="font-bold text-gray-800 flex items-center"><Icons.UserCheck size={20} className="mr-2 text-orange-600"/> An치lisis de Cartera (Cuentas por Cobrar)</h3>
                                    <p className="text-sm text-gray-500">Gesti칩n de riesgo y antig칲edad de deuda por cliente.</p>
                                </div>
                                <div className="text-right">
                                    <span className="block text-xs text-gray-400 uppercase font-bold">Deuda Total</span>
                                    <span className="text-2xl font-bold text-orange-600">{formatCurrency(receivablesAnalysis.grandTotal)}</span>
                                </div>
                             </div>

                             <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-gray-50 text-gray-600 border-b uppercase text-xs">
                                            <tr>
                                                <th className="p-3">Cliente</th>
                                                <th className="p-3 text-center">Facturas</th>
                                                <th className="p-3 text-center">Estado del Vencimiento (Antiguo)</th>
                                                <th className="p-3 text-right">Total Deuda</th>
                                                <th className="p-3 text-right">% del Total</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {receivablesAnalysis.clients.map(c => {
                                                const share = receivablesAnalysis.grandTotal > 0 ? (c.total / receivablesAnalysis.grandTotal) * 100 : 0;
                                                
                                                // SEM츼FORO FINANCIERO
                                                const today = new Date();
                                                today.setHours(0,0,0,0);
                                                const [y,m,d] = c.oldestDue.split('-').map(Number);
                                                const dueDateObj = new Date(y, m-1, d);
                                                const diffTime = dueDateObj - today;
                                                const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                                let statusBadge;
                                                if (daysDiff < 0) {
                                                    statusBadge = <span className="bg-red-100 text-red-700 border border-red-200 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center justify-center gap-1 w-fit mx-auto"><Icons.Alert size={10}/> Vencido hace {Math.abs(daysDiff)} d칤as</span>;
                                                } else if (daysDiff <= 3) {
                                                    statusBadge = <span className="bg-orange-100 text-orange-700 border border-orange-200 text-[10px] px-2 py-0.5 rounded-full font-bold w-fit mx-auto">Vence pronto ({daysDiff} d칤as)</span>;
                                                } else {
                                                    statusBadge = <span className="bg-blue-50 text-blue-600 border border-blue-100 text-[10px] px-2 py-0.5 rounded-full font-bold w-fit mx-auto">Al d칤a ({daysDiff} d칤as)</span>;
                                                }

                                                return (
                                                    <tr key={c.id} className="hover:bg-gray-50 group">
                                                        <td 
                                                            className="p-3 font-medium text-gray-800 cursor-pointer hover:text-indigo-600 transition-colors"
                                                            onClick={() => setViewingClientDebt(c)}
                                                            title="Clic para ver detalle de facturas pendientes"
                                                        >
                                                            <div className="flex items-center gap-2">
                                                                {c.name}
                                                                <Icons.Search size={14} className="text-gray-300 group-hover:text-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity"/>
                                                            </div>
                                                            {share > 30 && <div className="text-[10px] text-red-500 flex items-center mt-1"><Icons.Alert size={10} className="mr-1"/> Riesgo de Concentraci칩n</div>}
                                                        </td>
                                                        <td className="p-3 text-center text-gray-500">{c.count} doc(s)</td>
                                                        <td className="p-3 text-center">
                                                            <div className="flex flex-col gap-1">
                                                                <span className="font-mono text-xs text-gray-700">{formatDate(c.oldestDue)}</span>
                                                                {statusBadge}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-gray-800 text-base">{formatCurrency(c.total)}</td>
                                                        <td className="p-3 text-right">
                                                            <div className="flex items-center justify-end gap-2">
                                                                <span className="text-xs text-gray-500">{share.toFixed(1)}%</span>
                                                                <div className="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                                                    <div className={`h-full ${share > 50 ? 'bg-red-500' : share > 20 ? 'bg-orange-400' : 'bg-green-400'}`} style={{width: `${share}%`}}></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )
                                            })}
                                            {receivablesAnalysis.clients.length === 0 && (
                                                <tr>
                                                    <td colSpan="5" className="p-8 text-center text-gray-400">
                                                        <div className="flex flex-col items-center justify-center">
                                                            <div className="bg-green-50 p-3 rounded-full mb-3"><Icons.Check size={32} className="text-green-500"/></div>
                                                            <p>춰Excelente! No tienes deudas pendientes por cobrar.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                );
            }

            // VISTA: CARTERA DE PROVEEDORES (CUENTAS POR PAGAR)
            if (view === 'payables') {
                return (
                    <div className="animate-fade-in space-y-4">
                        {/* --- MODAL DETALLE DE FACTURAS POR PROVEEDOR --- */}
                        {viewingSupplierDebt && (
                            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4" onClick={() => setViewingSupplierDebt(null)}>
                                <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <div>
                                            <h3 className="font-bold text-gray-800">Detalle de Deuda</h3>
                                            <p className="text-xs text-gray-500">{viewingSupplierDebt.name}</p>
                                        </div>
                                        <button onClick={() => setViewingSupplierDebt(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button>
                                    </div>
                                    <div className="p-0 overflow-y-auto max-h-[60vh]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-xs uppercase text-gray-500 border-b sticky top-0">
                                                <tr><th className="p-3">Factura / Emisi칩n</th><th className="p-3 text-center">Vence</th><th className="p-3 text-right">Monto</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {viewingSupplierDebt.invoices.sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).map((inv, i) => {
                                                    const today = new Date(); today.setHours(0,0,0,0);
                                                    const [y,m,d] = inv.dueDate.split('-').map(Number);
                                                    const dueD = new Date(y,m-1,d);
                                                    const isPastDue = dueD < today;
                                                    
                                                    return (
                                                        <tr key={i} className="hover:bg-gray-50">
                                                            <td className="p-3">
                                                                <div className="font-bold text-gray-700">{inv.invoiceNo}</div>
                                                                <div className="text-[10px] text-gray-400">Emisi칩n: {formatDate(inv.date)}</div>
                                                            </td>
                                                            <td className="p-3 text-center">
                                                                <div className={`text-xs font-medium ${isPastDue ? 'text-red-600' : 'text-blue-600'}`}>{formatDate(inv.dueDate)}</div>
                                                                {isPastDue && <div className="text-[9px] text-red-500 font-bold uppercase">Vencido</div>}
                                                            </td>
                                                            <td className="p-3 text-right font-bold text-gray-800">{formatCurrency(inv.total)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="p-3 bg-red-50 border-t flex justify-between items-center">
                                        <span className="text-xs font-bold text-red-800 uppercase">Total Pendiente</span>
                                        <span className="font-bold text-red-700 text-lg">{formatCurrency(viewingSupplierDebt.total)}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        <button onClick={() => setView('dashboard')} className="flex items-center text-sm text-gray-500 hover:text-indigo-600 font-medium transition-colors mb-2">
                             Volver al Panel
                        </button>
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                             <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h3 className="font-bold text-gray-800 flex items-center"><Icons.Truck size={20} className="mr-2 text-red-600"/> Cartera de Proveedores (Cuentas por Pagar)</h3>
                                    <div className="flex items-center gap-2 mt-1">
                                        <p className="text-sm text-gray-500">Obligaciones pendientes.</p>
                                        <span className="bg-red-50 text-red-700 text-[10px] px-2 py-0.5 rounded-full font-bold border border-red-100">Hist칩rico Completo</span>
                                    </div>
                                    <p className="text-xs text-gray-400 mt-1 italic">Incluye facturas de a침os anteriores a칰n no pagadas.</p>
                                </div>
                                <div className="text-right">
                                    <span className="block text-xs text-gray-400 uppercase font-bold">Total por Pagar (Inc. IGV)</span>
                                    <span className="text-2xl font-bold text-red-600">{formatCurrency(payablesAnalysis.grandTotal)}</span>
                                </div>
                             </div>

                             <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-gray-50 text-gray-600 border-b uppercase text-xs">
                                            <tr>
                                                <th className="p-3">Proveedor</th>
                                                <th className="p-3 text-center">Facturas</th>
                                                <th className="p-3 text-center">Vencimiento M치s Pr칩ximo</th>
                                                <th className="p-3 text-right">Total Deuda</th>
                                                <th className="p-3 text-right">% del Total</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {payablesAnalysis.suppliers.map(s => {
                                                const share = payablesAnalysis.grandTotal > 0 ? (s.total / payablesAnalysis.grandTotal) * 100 : 0;
                                                
                                                // SEM츼FORO FINANCIERO (PAGOS)
                                                const today = new Date();
                                                today.setHours(0,0,0,0);
                                                const [y,m,d] = s.oldestDue.split('-').map(Number);
                                                const dueDateObj = new Date(y, m-1, d);
                                                const diffTime = dueDateObj - today;
                                                const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                                let statusBadge;
                                                if (daysDiff < 0) {
                                                    statusBadge = <span className="bg-red-100 text-red-700 border border-red-200 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center justify-center gap-1 w-fit mx-auto"><Icons.Alert size={10}/> Vencido hace {Math.abs(daysDiff)} d칤as</span>;
                                                } else if (daysDiff === 0) {
                                                    statusBadge = <span className="bg-red-500 text-white border border-red-600 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center justify-center gap-1 w-fit mx-auto">춰VENCE HOY!</span>;
                                                } else if (daysDiff <= 3) {
                                                    statusBadge = <span className="bg-orange-100 text-orange-700 border border-orange-200 text-[10px] px-2 py-0.5 rounded-full font-bold w-fit mx-auto">Vence en {daysDiff} d칤as</span>;
                                                } else {
                                                    statusBadge = <span className="bg-blue-50 text-blue-600 border border-blue-100 text-[10px] px-2 py-0.5 rounded-full font-bold w-fit mx-auto">En {daysDiff} d칤as</span>;
                                                }

                                                return (
                                                    <tr key={s.id} className="hover:bg-gray-50 group">
                                                        <td 
                                                            className="p-3 font-medium text-gray-800 cursor-pointer hover:text-blue-600 transition-colors"
                                                            onClick={() => setViewingSupplierDebt(s)}
                                                            title="Clic para ver facturas pendientes"
                                                        >
                                                            <div className="flex items-center gap-2">
                                                                {s.name}
                                                                <Icons.Search size={14} className="text-gray-300 group-hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"/>
                                                            </div>
                                                            <div className="text-[10px] text-gray-400 font-normal no-underline group-hover:text-blue-400">Clic para ver detalle</div>
                                                        </td>
                                                        <td className="p-3 text-center text-gray-500">{s.count} doc(s)</td>
                                                        <td className="p-3 text-center">
                                                            <div className="flex flex-col gap-1">
                                                                <span className="font-mono text-xs text-gray-700">{formatDate(s.oldestDue)}</span>
                                                                {statusBadge}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-right font-bold text-red-700 text-base">{formatCurrency(s.total)}</td>
                                                        <td className="p-3 text-right">
                                                            <div className="flex items-center justify-end gap-2">
                                                                <span className="text-xs text-gray-500">{share.toFixed(1)}%</span>
                                                                <div className="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                                                    <div className={`h-full ${share > 50 ? 'bg-red-500' : share > 20 ? 'bg-orange-400' : 'bg-green-400'}`} style={{width: `${share}%`}}></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )
                                            })}
                                            {payablesAnalysis.suppliers.length === 0 && (
                                                <tr>
                                                    <td colSpan="5" className="p-8 text-center text-gray-400">
                                                        <div className="flex flex-col items-center justify-center">
                                                            <div className="bg-green-50 p-3 rounded-full mb-3"><Icons.Check size={32} className="text-green-500"/></div>
                                                            <p>춰Todo en orden! No tienes facturas pendientes de pago.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                </table>
                             </div>
                        </div>
                    </div>
                );
            }

            // VISTA: DETALLE DE ROTACI칍N Y REPOSICI칍N
            return (
                <div className="animate-fade-in space-y-4">
                    <button onClick={() => setView('dashboard')} className="flex items-center text-sm text-gray-500 hover:text-indigo-600 font-medium transition-colors mb-2">
                         Volver al Panel
                    </button>

                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.FileText size={20} className="mr-2 text-indigo-600"/> An치lisis de Stock y Reposici칩n</h3>
                        <p className="text-sm text-gray-500 mb-6">
                            Sugerencia de compra calculada para cubrir <strong>45 d칤as</strong> de venta, basado en el promedio de los 칰ltimos 30 d칤as. Haz clic en los encabezados para ordenar.
                        </p>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 text-gray-600 border-b uppercase text-xs">
                                    <tr>
                                            <th className="p-3 cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestRepSort('name')}><div className="flex items-center">Producto {getRepSortIcon('name')}</div></th>
                                            <th className="p-3 text-center cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestRepSort('stock')}><div className="flex items-center justify-center">Stock Actual {getRepSortIcon('stock')}</div></th>
                                            <th className="p-3 text-center bg-blue-50 text-blue-800 cursor-pointer hover:bg-blue-100 transition select-none" onClick={() => requestRepSort('sold30d')}><div className="flex items-center justify-center">Venta 30 D칤as {getRepSortIcon('sold30d')}</div></th>
                                            <th className="p-3 text-center cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestRepSort('dailyRate')}><div className="flex items-center justify-center">Venta Diaria Prom. {getRepSortIcon('dailyRate')}</div></th>
                                            <th className="p-3 text-center cursor-pointer hover:bg-gray-50 transition select-none" onClick={() => requestRepSort('rotation')}><div className="flex items-center justify-center">Rotaci칩n {getRepSortIcon('rotation')}</div></th>
                                            <th className="p-3 text-right bg-green-50 text-green-800 border-l border-green-100 font-bold cursor-pointer hover:bg-green-100 transition select-none" onClick={() => requestRepSort('suggested')}><div className="flex items-center justify-end">SUGERIDO A COMPRAR {getRepSortIcon('suggested')}</div></th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {inventoryAnalysis.map(p => (
                                        <tr key={p.id} className="hover:bg-gray-50">
                                            <td className="p-3 font-medium text-gray-800">
                                                {p.name}
                                                <div className="text-[10px] text-gray-400">Costo: {formatCurrency(p.cost)}</div>
                                            </td>
                                            <td className="p-3 text-center">{p.stock}</td>
                                            <td className="p-3 text-center bg-blue-50/30 font-medium text-blue-700">{p.replenishment.sold30d} un.</td>
                                            <td className="p-3 text-center text-xs text-gray-500">{p.replenishment.dailyRate.toFixed(2)} / d칤a</td>
                                            <td className="p-3 text-center"><span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${p.rotation.color}`}>{p.rotation.label}</span></td>
                                            
                                            <td className={`p-3 text-right border-l border-green-50 ${p.replenishment.suggested > 0 ? 'bg-green-50/50' : ''}`}>
                                                {p.replenishment.suggested > 0 ? (
                                                    <div className="flex flex-col items-end">
                                                        <span className="text-green-700 font-bold text-lg">+{p.replenishment.suggested}</span>
                                                        <span className="text-[9px] text-green-600">Est. Costo: {formatCurrency(p.replenishment.suggested * p.cost)}</span>
                                                    </div>
                                                ) : (
                                                    <span className="text-gray-300 text-xs font-medium">Stock Suficiente</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const SmartProductSelect = ({ products, value, onChange }) => {
            const [query, setQuery] = React.useState('');
            const [isOpen, setIsOpen] = React.useState(false);
            const wrapperRef = React.useRef(null);

            // Filtrar solo productos activos
            const activeProducts = products.filter(p => p.status !== 'inactive');

            React.useEffect(() => {
                if (value) {
                    const selected = activeProducts.find(p => p.id === value);
                    if (selected && document.activeElement !== wrapperRef.current?.querySelector('input')) {
                        setQuery(selected.name);
                    }
                } else if (document.activeElement !== wrapperRef.current?.querySelector('input')) {
                     setQuery('');
                }
            }, [value, activeProducts]);

            const filtered = activeProducts.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleSelect = (prod) => {
                setQuery(prod.name);
                onChange(prod.id);
                setIsOpen(false);
            };

            const handleInputChange = (e) => {
                setQuery(e.target.value);
                setIsOpen(true);
                if (value) onChange(''); 
            };

            return (
                <div ref={wrapperRef} className="relative w-full">
                    <div className="relative">
                         <input
                            type="text"
                            className={`w-full p-2 pl-9 pr-8 border rounded text-sm outline-none transition-shadow ${isOpen ? 'ring-2 ring-blue-500 border-blue-500' : 'focus:ring-2 focus:ring-blue-200'}`}
                            placeholder="Buscar producto..."
                            value={query}
                            onChange={handleInputChange}
                            onFocus={() => setIsOpen(true)}
                        />
                        <div className="absolute left-3 top-2.5 text-gray-400">
                             <Icons.Search size={16}/> 
                        </div>
                        {value && (
                            <button 
                                onClick={() => { onChange(''); setQuery(''); }}
                                className="absolute right-2 top-2.5 text-gray-400 hover:text-red-500"
                                title="Limpiar selecci칩n"
                            >
                                <Icons.X size={14} />
                            </button>
                        )}
                    </div>

                    {isOpen && (
                        <ul className="absolute z-50 w-full bg-white border border-gray-200 mt-1 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                            {filtered.length > 0 ? (
                                filtered.map(p => (
                                    <li 
                                        key={p.id}
                                        onClick={() => handleSelect(p)}
                                        className="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors"
                                    >
                                        <div className="flex justify-between items-center">
                                            <span className="font-medium text-gray-800 text-sm">{p.name}</span>
                                            <span className="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full font-bold">{formatCurrency(p.price)}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1 flex justify-between">
                                            <span>Stock: <span className={p.stock < 10 ? "text-red-500 font-bold" : "text-gray-600 font-medium"}>{p.stock}</span></span>
                                            <span className="text-gray-400">Costo: {formatCurrency(p.cost)}</span>
                                        </div>
                                    </li>
                                ))
                            ) : (
                                <li className="p-4 text-gray-400 text-sm text-center italic">
                                    No se encontraron productos "{query}"
                                </li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };

        const Sales = ({ db, userId, clients, products, salesList, transactionJump, onJumpHandled, showNotification }) => { 
            const [showForm, setShowForm] = React.useState(false);
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [selectedClient, setSelectedClient] = React.useState('');
            
            // --- NUEVOS FILTROS DE FECHA (DEFAULT: MES ACTUAL) ---
            const [filterMonth, setFilterMonth] = React.useState(new Date().getMonth()); // 0-11
            const [filterYear, setFilterYear] = React.useState(new Date().getFullYear()); // 202X
            
            const [filterClient, setFilterClient] = React.useState('');
            const [filterStatus, setFilterStatus] = React.useState('all');

            const months = [ "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre" ];
            const years = [2024, 2025, 2026];

            const [items, setItems] = React.useState([]);
            const [itemProd, setItemProd] = React.useState('');
            const [itemQty, setItemQty] = React.useState(1);
            const [itemPrice, setItemPrice] = React.useState(0);
            const [saleDate, setSaleDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [dueDate, setDueDate] = React.useState(calculatePaymentDate(new Date().toISOString().split('T')[0]));
            const [stockWarning, setStockWarning] = React.useState(null);
            const [editingSaleId, setEditingSaleId] = React.useState(null);
            const [originalSaleItems, setOriginalSaleItems] = React.useState([]);
            const [deletingId, setDeletingId] = React.useState(null);
            const [viewingSale, setViewingSale] = React.useState(null);
            const [priceSource, setPriceSource] = React.useState('');

            React.useEffect(() => {
                if (transactionJump && transactionJump.type === 'sale' && salesList.length > 0) {
                    const targetSale = salesList.find(s => s.id === transactionJump.id);
                    if (targetSale) {
                        setViewingSale(targetSale);
                        onJumpHandled(); 
                    }
                }
            }, [transactionJump, salesList]);

            const getSaleProfitMetrics = (sale) => {
                const netSale = sale.subtotal || (sale.total / 1.18);
                let totalCost = 0;
                if (sale.items) {
                    sale.items.forEach(item => {
                        let unitCost = item.cost;
                        // Fallback: Si no hay costo hist칩rico, usar costo actual
                        if (!unitCost || unitCost === 0) {
                            const currentProd = products.find(p => p.id === item.productId);
                            if (currentProd) unitCost = currentProd.cost;
                        }
                        totalCost += (unitCost || 0) * item.qty;
                    });
                }
                const profit = netSale - totalCost;
                const margin = netSale > 0 ? (profit / netSale) * 100 : 0;
                return { profit, margin };
            };

            const handleDateChange = (e) => {
                const newDate = e.target.value;
                setSaleDate(newDate);
                setDueDate(calculatePaymentDate(newDate)); 
            };

            const handleProductSelect = (pid) => {
                setItemProd(pid);
                const prod = products.find(p => p.id === pid);
                if (prod) {
                    let suggestedPrice = prod.price; 
                    let sourceInfo = "Precio Base (Cat치logo)";
                    const productSales = salesList.filter(s => s.items && s.items.some(i => i.productId === pid));
                    if (productSales.length > 0) {
                        if (selectedClient) {
                            const lastClientSale = productSales.find(s => s.clientId === selectedClient);
                            if (lastClientSale) {
                                const item = lastClientSale.items.find(i => i.productId === pid);
                                if (item) { suggestedPrice = item.price; sourceInfo = `칔ltima venta a ${lastClientSale.clientName}`; }
                            } else {
                                const lastGlobalSale = productSales[0];
                                const item = lastGlobalSale.items.find(i => i.productId === pid);
                                if (item) { suggestedPrice = item.price; sourceInfo = "칔ltima venta global (Tendencia)"; }
                            }
                        } else {
                            const lastGlobalSale = productSales[0];
                            const item = lastGlobalSale.items.find(i => i.productId === pid);
                            if (item) { suggestedPrice = item.price; sourceInfo = "칔ltima venta global"; }
                        }
                    }
                    setItemPrice(suggestedPrice);
                    setPriceSource(sourceInfo);
                    checkStock(prod, itemQty);
                } else {
                    setItemPrice(0); setStockWarning(null); setPriceSource('');
                }
            };

            const checkStock = (prod, qty) => {
                if (!prod) return;
                let currentStock = prod.stock;
                if (editingSaleId) {
                    const originalItem = originalSaleItems.find(i => i.productId === prod.id);
                    if (originalItem) currentStock += originalItem.qty;
                }
                if (currentStock < qty) setStockWarning(`丘멆잺 Stock disponible: ${currentStock}. Se generar치 saldo negativo.`);
                else setStockWarning(null);
            };

            const handleQtyChange = (e) => {
                const qty = parseInt(e.target.value);
                setItemQty(qty);
                const prod = products.find(p => p.id === itemProd);
                if (prod) checkStock(prod, qty);
            };

            const handleAddItem = () => {
                if(!itemProd || itemQty <= 0) return;
                const prod = products.find(p => p.id === itemProd);
                const newItem = { productId: prod.id, productName: prod.name, qty: parseInt(itemQty), price: parseFloat(itemPrice), cost: prod.cost, subtotal: parseInt(itemQty) * parseFloat(itemPrice) };
                setItems([...items, newItem]);
                setItemProd(''); setItemQty(1); setItemPrice(0); setStockWarning(null); setPriceSource('');
            };

            const handleRemoveItem = (index) => { const newItems = items.filter((_, i) => i !== index); setItems(newItems); };
            const handleUpdateQuantity = (index, newQty) => { const val = parseInt(newQty); if (val < 1) return; const newItems = [...items]; newItems[index].qty = val; newItems[index].subtotal = val * newItems[index].price; setItems(newItems); };

            const handleEditSale = (sale) => {
                setSelectedClient(sale.clientId); setSaleDate(sale.date); setDueDate(sale.dueDate); setItems(sale.items); setEditingSaleId(sale.id); setOriginalSaleItems(sale.items); setShowForm(true);
            };

            const cancelEdit = () => {
                setShowForm(false); setEditingSaleId(null); setOriginalSaleItems([]); setItems([]); setSelectedClient(''); setSaleDate(new Date().toISOString().split('T')[0]); setDueDate(calculatePaymentDate(new Date().toISOString().split('T')[0]));
            };

            const handleDeleteSale = async (sale) => {
                setDeletingId(sale.id);
                try {
                    for (let item of sale.items) {
                        const prodRef = doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId);
                        const prodSnap = await getDoc(prodRef);
                        if(prodSnap.exists()) await updateDoc(prodRef, { stock: (prodSnap.data().stock || 0) + item.qty });
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', sale.id));
                    showNotification("Venta anulada y stock reversado correctamente.", 'success');
                } catch(e) { console.error("Error eliminando venta:", e); showNotification("Error al anular venta.", 'error'); } finally { setDeletingId(null); }
            };

            const subtotal = items.reduce((acc, curr) => acc + curr.subtotal, 0);
            const igv = subtotal * 0.18;
            const total = subtotal + igv;

            const handleSaveSale = async () => {
                if(!selectedClient || items.length === 0) return;
                setIsSubmitting(true);
                const client = clients.find(c => c.id === selectedClient);
                const saleData = { clientId: selectedClient, clientName: client.name, date: saleDate, dueDate: dueDate, items, subtotal, igv, total, status: 'Pendiente', updatedAt: Timestamp.now() };

                try {
                    if (editingSaleId) {
                        for (let item of originalSaleItems) {
                            const prodRef = doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId);
                            const prodSnap = await getDoc(prodRef);
                            if(prodSnap.exists()) await updateDoc(prodRef, { stock: (prodSnap.data().stock || 0) + item.qty });
                        }
                        for (let item of items) {
                            const prodRef = doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId);
                            const prodSnap = await getDoc(prodRef);
                            if(prodSnap.exists()) await updateDoc(prodRef, { stock: (prodSnap.data().stock || 0) - item.qty });
                        }
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', editingSaleId), saleData);
                        showNotification("Venta actualizada exitosamente.", 'success');
                    } else {
                        saleData.createdAt = Timestamp.now();
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'sales'), saleData);
                        for (let item of items) {
                            const prod = products.find(p => p.id === item.productId);
                            if(prod) await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', prod.id), { stock: prod.stock - item.qty });
                        }
                        showNotification("Venta registrada exitosamente.", 'success');
                    }
                    cancelEdit();
                } catch (e) { console.error(e); showNotification("Error al guardar venta.", 'error'); } finally { setIsSubmitting(false); }
            };

            const markAsPaid = async (saleId) => { try { await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', saleId), { status: 'Pagado', paymentDate: new Date().toISOString() }); showNotification("Marcado como pagado.", 'success'); } catch (e) { console.error(e); showNotification("Error al actualizar estado.", 'error'); } };
            const markAsPending = async (saleId) => { try { await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'sales', saleId), { status: 'Pendiente', paymentDate: null }); showNotification("Revertido a pendiente.", 'success'); } catch (e) { console.error(e); showNotification("Error al revertir estado.", 'error'); } };

            const sortedClients = [...clients].sort((a, b) => a.name.localeCompare(b.name));

            // --- L칍GICA DE EXPORTACI칍N Y FILTRADO AVANZADO ---
            const filteredSales = salesList.filter(s => {
                const clientMatch = filterClient ? s.clientId === filterClient : true;
                const statusMatch = filterStatus === 'all' ? true : s.status === filterStatus;
                
                const [sYear, sMonth, sDay] = s.date.split('-').map(Number);
                
                const yearMatch = filterYear === 'all' ? true : sYear === parseInt(filterYear);
                const monthMatch = filterMonth === 'all' ? true : (sMonth - 1) === parseInt(filterMonth);

                return clientMatch && statusMatch && yearMatch && monthMatch;
            });

            const handleExportExcel = () => {
                if (filteredSales.length === 0) {
                    showNotification("No hay datos para exportar.", 'error');
                    return;
                }

                // Generar CSV
                const header = ["Fecha Emision", "Vencimiento", "Cliente", "Estado", "Subtotal (S/)", "IGV (S/)", "Total (S/)"];
                const rows = filteredSales.map(s => [
                    formatDate(s.date),
                    formatDate(s.dueDate),
                    `"${s.clientName}"`, // Comillas para nombres con comas
                    s.status,
                    s.subtotal?.toFixed(2) || (s.total/1.18).toFixed(2),
                    s.igv?.toFixed(2) || (s.total - (s.total/1.18)).toFixed(2),
                    s.total.toFixed(2)
                ]);

                const csvContent = "data:text/csv;charset=utf-8," 
                    + [header, ...rows].map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Ventas_${months[filterMonth] || 'Global'}_${filterYear}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const totalFilteredAmount = filteredSales.reduce((acc, s) => acc + s.total, 0);

            return (
                <React.Fragment>
                    {/* ... (Modal view code remains same) ... */}
                    {viewingSale && (
                        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4" onClick={() => setViewingSale(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-800 flex items-center"><Icons.Cart size={18} className="mr-2 text-blue-600"/> Detalle de Venta</h3>
                                    <button onClick={() => setViewingSale(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button>
                                </div>
                                <div className="p-6">
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div><span className="block text-xs text-gray-500 uppercase font-bold">Cliente</span><span className="text-sm font-medium text-gray-800">{viewingSale.clientName}</span></div>
                                        <div><span className="block text-xs text-gray-500 uppercase font-bold">Fecha Emisi칩n</span><span className="text-sm font-medium text-gray-800">{formatDate(viewingSale.date)}</span></div>
                                        <div><span className="block text-xs text-gray-500 uppercase font-bold">Estado</span><span className={`text-xs font-bold px-2 py-1 rounded ${viewingSale.status === 'Pagado' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>{viewingSale.status}</span></div>
                                        <div><span className="block text-xs text-gray-500 uppercase font-bold">Total Facturado</span><span className="text-lg font-bold text-blue-600">{formatCurrency(viewingSale.total)}</span></div>
                                    </div>
                                    <div className="border rounded-lg overflow-hidden max-h-60 overflow-y-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-600 text-xs uppercase border-b"><tr><th className="p-3">Producto</th><th className="p-3 text-center">Cant.</th><th className="p-3 text-right">Precio U.</th><th className="p-3 text-right">Subtotal</th></tr></thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {viewingSale.items.map((item, idx) => (
                                                    <tr key={idx}><td className="p-3 text-gray-800">{item.productName}</td><td className="p-3 text-center text-gray-600">{item.qty}</td><td className="p-3 text-right text-gray-600">{formatCurrency(item.price)}</td><td className="p-3 text-right font-medium text-gray-800">{formatCurrency(item.subtotal)}</td></tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 flex justify-between items-end border-t border-gray-100 pt-4">
                                        <div className="bg-green-50 px-4 py-2 rounded-lg border border-green-100">
                                            <span className="block text-[10px] text-green-600 font-bold uppercase tracking-wider mb-1">Utilidad (Sin IGV)</span>
                                            <div className="flex items-baseline gap-2">
                                                <span className="text-lg font-bold text-green-700">{formatCurrency(getSaleProfitMetrics(viewingSale).profit)}</span>
                                                <span className="text-xs text-green-600 font-medium">({getSaleProfitMetrics(viewingSale).margin.toFixed(1)}%)</span>
                                            </div>
                                        </div>
                                        <div className="text-right text-xs text-gray-500 space-y-1">
                                            <p>Subtotal: <span className="font-medium text-gray-700">{formatCurrency(viewingSale.subtotal)}</span></p>
                                            <p>IGV (18%): <span className="font-medium text-gray-700">{formatCurrency(viewingSale.igv)}</span></p>
                                            <p className="text-sm font-bold text-blue-600 mt-1 border-t border-gray-100 pt-1">Total: {formatCurrency(viewingSale.total)}</p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex justify-end">
                                    <button onClick={() => setViewingSale(null)} className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="animate-fade-in relative">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-800">Gesti칩n de Ventas</h2>
                            <button onClick={() => setShowForm(!showForm)} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-sm">{showForm ? 'Cancelar' : <><Icons.Plus size={18} className="mr-2"/> Nueva Venta</>}</button>
                        </div>
                        
                        {/* BARRA DE HERRAMIENTAS DE FILTRO Y EXPORTACI칍N */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                            <div className="flex gap-3 w-full md:w-auto flex-wrap">
                                <select className="border p-2 rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)}>
                                    <option value="all">Todo el A침o</option>
                                    {months.map((m, i) => <option key={i} value={i}>{m}</option>)}
                                </select>
                                <select className="border p-2 rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500" value={filterYear} onChange={(e) => setFilterYear(e.target.value)}>
                                    <option value="all">Todos</option>
                                    {years.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>

                                <select 
                                    className="border p-2 rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-48"
                                    value={filterClient}
                                    onChange={(e) => setFilterClient(e.target.value)}
                                >
                                    <option value="">Todos los Clientes</option>
                                    {sortedClients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                <select 
                                    className="border p-2 rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500"
                                    value={filterStatus}
                                    onChange={(e) => setFilterStatus(e.target.value)}
                                >
                                    <option value="all">Estado: Todos</option>
                                    <option value="Pendiente">Solo Pendientes</option>
                                    <option value="Pagado">Solo Pagados</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                                <div className="text-right">
                                    <span className="block text-[10px] text-gray-400 uppercase font-bold">Total Filtrado</span>
                                    <span className="font-bold text-gray-800">{formatCurrency(totalFilteredAmount)}</span>
                                </div>
                                <button 
                                    onClick={handleExportExcel}
                                    className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 transition shadow-sm font-medium text-sm"
                                >
                                    <Icons.Download size={18}/> Exportar
                                </button>
                            </div>
                        </div>

                        {showForm && (
                            <div className="bg-white p-6 rounded-xl shadow-md mb-6 border border-blue-100 relative">
                                {editingSaleId && <div className="absolute top-0 right-0 bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-bl-xl font-bold">Modo Edici칩n</div>}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div><label className="text-sm font-semibold text-gray-600">Cliente</label><select className="w-full p-2 border rounded mt-1 bg-gray-50" value={selectedClient} onChange={e => setSelectedClient(e.target.value)}><option value="">Seleccionar Cliente</option>{sortedClients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                                    <div className="flex gap-2"><div className="w-1/2"><label className="text-sm font-semibold text-gray-600">Fecha Emisi칩n</label><input type="date" className="w-full p-2 border rounded mt-1 bg-gray-50" value={saleDate} onChange={handleDateChange} /></div><div className="w-1/2"><label className="text-sm font-semibold text-gray-600">Fecha Vencimiento</label><input type="date" className="w-full p-2 border rounded mt-1 bg-white border-blue-200 text-blue-700 font-medium" value={dueDate} onChange={e => setDueDate(e.target.value)} /></div></div>
                                </div>
                                <div className={`bg-gray-50 p-4 rounded-lg mb-4 border ${stockWarning ? 'border-orange-300 bg-orange-50' : 'border-gray-200'}`}>
                                    <div className="flex gap-2 items-end"><div className="flex-1"><label className="text-xs text-gray-500 font-bold mb-1 block">BUSCAR PRODUCTO</label><SmartProductSelect products={products} value={itemProd} onChange={handleProductSelect} /></div><div className="w-24"><label className="text-xs text-gray-500 font-bold">PRECIO (S/ IGV)</label><input type="number" className="w-full p-2 border rounded text-sm" value={itemPrice} onChange={e => setItemPrice(e.target.value)} /></div><div className="w-20"><label className="text-xs text-gray-500 font-bold">CANT</label><input type="number" className="w-full p-2 border rounded text-sm" value={itemQty} onChange={handleQtyChange} /></div><button onClick={handleAddItem} className="bg-gray-800 text-white p-2 rounded hover:bg-black transition"><Icons.Plus size={20}/></button></div>
                                    <div className="flex justify-between items-start mt-1">
                                        <div className="flex flex-col">
                                            <p className="text-[10px] text-gray-500">* Precio unitario editable para esta venta.</p>
                                            {priceSource && <p className="text-[10px] font-semibold text-blue-600 bg-blue-50 px-1 rounded inline-block mt-0.5">좶잺 {priceSource}</p>}
                                        </div>
                                        {stockWarning && <p className="text-xs font-bold text-orange-600 animate-pulse">{stockWarning}</p>}
                                    </div>
                                </div>
                                {items.length > 0 && (<div className="mb-4"><table className="w-full text-sm mb-2"><thead><tr className="text-left text-gray-500 border-b"><th className="py-2">Prod</th><th className="w-20 text-center">Cant</th><th className="text-right">Precio U.</th><th className="text-right">Total</th><th className="w-10"></th></tr></thead><tbody>{items.map((i, idx) => (<tr key={idx} className="border-b border-gray-100"><td className="py-2">{i.productName}</td><td className="text-center"><input type="number" min="1" className="w-16 border rounded p-1 text-center bg-white focus:ring-1 focus:ring-blue-300 outline-none" value={i.qty} onChange={(e) => handleUpdateQuantity(idx, e.target.value)}/></td><td className="text-right">{formatCurrency(i.price)}</td><td className="text-right">{formatCurrency(i.subtotal)}</td><td className="text-right"><button onClick={() => handleRemoveItem(idx)} className="text-red-400 hover:text-red-600 p-1 hover:bg-red-50 rounded transition" title="Eliminar item"><Icons.Trash size={16} /></button></td></tr>))}</tbody></table><div className="text-right space-y-1 pt-2 border-t"><div className="text-sm text-gray-600">Subtotal: {formatCurrency(subtotal)}</div><div className="text-sm text-gray-600">IGV (18%): {formatCurrency(igv)}</div><div className="font-bold text-lg text-gray-800">Total: {formatCurrency(total)}</div></div></div>)}
                                <div className="flex gap-3">{editingSaleId && <button onClick={cancelEdit} className="w-1/3 bg-gray-200 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-300 transition">Cancelar</button>}<button onClick={handleSaveSale} disabled={items.length === 0 || isSubmitting} className={`flex-1 text-white py-3 rounded-lg font-bold disabled:opacity-50 transition flex justify-center items-center ${editingSaleId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}>{isSubmitting ? <div className="loader mr-2"></div> : null}{isSubmitting ? 'Procesando...' : (editingSaleId ? 'Actualizar Factura' : 'Emitir Factura')}</button></div>
                            </div>
                        )}
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                            <div className="overflow-x-auto"><table className="w-full text-left text-sm">
                                <thead className="bg-gray-50 text-gray-600 border-b">
                                    <tr>
                                        <th className="p-4">Cliente</th>
                                        <th className="p-4">Fecha</th>
                                        <th className="p-4">Vence</th>
                                        <th className="p-4 text-right">Total</th>
                                        <th className="p-4 text-right">Utilidad</th>
                                        <th className="p-4 text-center">Estado</th>
                                        <th className="p-4 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filteredSales.map(sale => {
                                        const { profit, margin } = getSaleProfitMetrics(sale);
                                        return (
                                            <tr key={sale.id} className="hover:bg-gray-50 transition-colors">
                                                <td className="p-4 font-medium">{sale.clientName}</td>
                                                <td className="p-4">{formatDate(sale.date)}</td>
                                                <td className="p-4 text-blue-600 font-medium">{formatDate(sale.dueDate)}</td>
                                                <td className="p-4 text-right font-bold">{formatCurrency(sale.total)}</td>
                                                <td className="p-4 text-right">
                                                    <div className="font-bold text-green-600">{formatCurrency(profit)}</div>
                                                    <div className="text-xs text-green-500 font-medium">{margin.toFixed(0)}%</div>
                                                </td>
                                                <td className="p-4 text-center"><span className={`px-2 py-1 rounded-full text-xs font-semibold ${sale.status === 'Pagado' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>{sale.status}</span></td>
                                                <td className="p-4 text-right flex justify-end items-center gap-2">
                                                    <button onClick={() => setViewingSale(sale)} className="text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 p-1 rounded transition" title="Ver Detalle"><Icons.Eye size={18}/></button>
                                                    {sale.status === 'Pendiente' ? (<><button onClick={() => markAsPaid(sale.id)} className="text-green-600 hover:bg-green-50 p-1 rounded transition" title="Marcar Pagado"><Icons.Check size={18}/></button><button onClick={() => handleEditSale(sale)} disabled={!!editingSaleId} className="text-blue-500 hover:bg-blue-50 p-1 rounded transition disabled:opacity-30" title="Editar"><Icons.Edit size={18}/></button></>) : (<button onClick={() => markAsPending(sale.id)} className="text-orange-500 hover:bg-orange-50 p-1 rounded transition" title="Revertir a Pendiente (Error)"><Icons.Clock size={18}/></button>)}<button onClick={() => handleDeleteSale(sale)} disabled={deletingId === sale.id || !!editingSaleId} className="text-red-400 hover:bg-red-50 p-1 rounded transition disabled:opacity-30" title="Anular Factura">{deletingId === sale.id ? '...' : <Icons.Trash size={18}/>}</button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {filteredSales.length === 0 && (
                                        <tr>
                                            <td colSpan="7" className="p-8 text-center text-gray-400 italic">No se encontraron ventas con los filtros seleccionados.</td>
                                        </tr>
                                    )}
                                </tbody>
                            </table></div>
                        </div>
                    </div>
                </React.Fragment>
            );
        };

        const Clients = ({ db, userId, clients, showNotification }) => {
            const [name, setName] = React.useState('');
            const [type, setType] = React.useState('Restaurante');
            const [ruc, setRuc] = React.useState('');
            const [contact, setContact] = React.useState('');
            const [address, setAddress] = React.useState('');
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [editingId, setEditingId] = React.useState(null);

            const handleEdit = (client) => {
                setName(client.name);
                setType(client.type);
                setRuc(client.ruc || '');
                setContact(client.contact || '');
                setAddress(client.address || '');
                setEditingId(client.id);
            };

            const cancelEdit = () => {
                setName('');
                setType('Restaurante');
                setRuc('');
                setContact('');
                setAddress('');
                setEditingId(null);
            };

            const saveClient = async () => {
                if(!name) return;
                setIsSubmitting(true);
                try { 
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', editingId), { name, type, ruc, contact, address });
                        showNotification("Cliente actualizado correctamente.", 'success');
                        cancelEdit();
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'clients'), { name, type, ruc, contact, address, createdAt: Timestamp.now() }); 
                        setName(''); setRuc(''); setContact(''); setAddress(''); 
                        showNotification("Cliente registrado exitosamente.", 'success');
                    }
                } catch(e) { 
                    console.error(e); 
                    showNotification("Error al guardar cliente.", 'error');
                } finally { setIsSubmitting(false); }
            };

            const deleteClient = async (id) => { 
                try { 
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', id)); 
                    showNotification("Cliente eliminado.", 'success');
                } catch(e) { showNotification("Error al eliminar.", 'error'); } 
            };

            return (
                <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                        <h3 className="font-bold mb-4 flex items-center text-gray-800"><Icons.Users size={20} className="mr-2 text-blue-600"/> {editingId ? 'Editar Cliente' : 'Nuevo Cliente'}</h3>
                        <div className="space-y-3">
                            <input className="w-full border p-2 rounded text-sm" placeholder="Raz칩n Social" value={name} onChange={e=>setName(e.target.value)} />
                            <select className="w-full border p-2 rounded text-sm" value={type} onChange={e=>setType(e.target.value)}><option value="Restaurante">Restaurante</option><option value="Cadena Fast Food">Cadena Fast Food</option></select>
                            <input className="w-full border p-2 rounded text-sm" placeholder="RUC" value={ruc} onChange={e=>setRuc(e.target.value)} />
                            <input className="w-full border p-2 rounded text-sm" placeholder="Contacto" value={contact} onChange={e=>setContact(e.target.value)} />
                            <input className="w-full border p-2 rounded text-sm" placeholder="Direcci칩n" value={address} onChange={e=>setAddress(e.target.value)} />
                            
                            <div className="flex gap-2">
                                {editingId && <button onClick={cancelEdit} className="w-1/3 bg-gray-200 text-gray-700 py-2 rounded text-sm font-bold hover:bg-gray-300 transition">Cancelar</button>}
                                <button onClick={saveClient} disabled={isSubmitting} className={`flex-1 text-white py-2 rounded text-sm font-bold transition disabled:opacity-50 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {isSubmitting ? 'Guardando...' : (editingId ? 'Actualizar' : 'Registrar')}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="col-span-1 md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between"><span>Cartera</span><span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">{clients.length}</span></div>
                        <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white text-gray-500 border-b"><tr><th className="p-3">Cliente</th><th className="p-3">Tipo</th><th className="p-3">RUC</th><th className="p-3">Contacto</th><th className="p-3 text-right">Acciones</th></tr></thead><tbody className="divide-y divide-gray-100">{clients.map(c => (<tr key={c.id} className="hover:bg-gray-50"><td className="p-3 font-bold text-gray-800">{c.name}<div className="text-xs text-gray-400 font-normal">{c.address}</div></td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-semibold ${c.type === 'Cadena Fast Food' ? 'bg-purple-100 text-purple-700' : 'bg-blue-50 text-blue-600'}`}>{c.type}</span></td><td className="p-3 font-mono text-xs">{c.ruc || '-'}</td><td className="p-3 text-gray-600">{c.contact}</td><td className="p-3 text-right flex justify-end gap-2"><button onClick={() => handleEdit(c)} className="text-blue-400 hover:text-blue-600 transition" title="Editar"><Icons.Edit size={16}/></button><button onClick={() => deleteClient(c.id)} className="text-gray-300 hover:text-red-500 transition" title="Eliminar"><Icons.Trash size={16}/></button></td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const Suppliers = ({ db, userId, suppliers, showNotification }) => {
            const [name, setName] = React.useState('');
            const [ruc, setRuc] = React.useState(''); 
            const [category, setCategory] = React.useState('Insumos');
            const [contactName, setContactName] = React.useState('');
            const [phone, setPhone] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [editingId, setEditingId] = React.useState(null);

            const handleEdit = (supplier) => {
                setName(supplier.name);
                setRuc(supplier.ruc || '');
                setCategory(supplier.category);
                setContactName(supplier.contactName || '');
                setPhone(supplier.phone || '');
                setEmail(supplier.email || '');
                setEditingId(supplier.id);
            };

            const cancelEdit = () => {
                setName(''); setRuc(''); setContactName(''); setPhone(''); setEmail('');
                setEditingId(null);
            };

            const saveSupplier = async () => {
                if(!name) return;
                setIsSubmitting(true);
                try { 
                    const data = { name, ruc, category, contactName, phone, email };
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'suppliers', editingId), data);
                        showNotification("Proveedor actualizado correctamente.", 'success');
                        cancelEdit();
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'suppliers'), { ...data, createdAt: Timestamp.now() }); 
                        setName(''); setRuc(''); setContactName(''); setPhone(''); setEmail(''); 
                        showNotification("Proveedor registrado exitosamente.", 'success');
                    }
                } catch(e) { 
                    console.error(e); 
                    showNotification("Error al guardar proveedor.", 'error');
                } finally { setIsSubmitting(false); }
            };

            const deleteSupplier = async (id) => { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'suppliers', id)); showNotification("Proveedor eliminado.", 'success'); } catch(e) { showNotification("Error al eliminar.", 'error'); } };

            return (
                <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit">
                        <h3 className="font-bold mb-4 flex items-center text-gray-800"><Icons.Truck size={20} className="mr-2 text-orange-600"/> {editingId ? 'Editar Proveedor' : 'Nuevo Proveedor'}</h3>
                        <div className="space-y-3">
                            <input className="w-full border p-2 rounded text-sm" placeholder="Raz칩n Social" value={name} onChange={e=>setName(e.target.value)} />
                            <input className="w-full border p-2 rounded text-sm" placeholder="RUC" value={ruc} onChange={e=>setRuc(e.target.value)} />
                            <select className="w-full border p-2 rounded text-sm" value={category} onChange={e=>setCategory(e.target.value)}><option value="Insumos">Insumos</option><option value="Limpieza">Limpieza</option><option value="Logistica">Log칤stica</option></select>
                            <input className="w-full border p-2 rounded text-sm" placeholder="Contacto" value={contactName} onChange={e=>setContactName(e.target.value)} />
                            <div className="grid grid-cols-2 gap-2"><input className="w-full border p-2 rounded text-sm" placeholder="Tel" value={phone} onChange={e=>setPhone(e.target.value)} /><input className="w-full border p-2 rounded text-sm" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} /></div>
                            
                            <div className="flex gap-2">
                                {editingId && <button onClick={cancelEdit} className="w-1/3 bg-gray-200 text-gray-700 py-2 rounded text-sm font-bold hover:bg-gray-300 transition">Cancelar</button>}
                                <button onClick={saveSupplier} disabled={isSubmitting} className={`flex-1 text-white py-2 rounded text-sm font-bold transition disabled:opacity-50 ${editingId ? 'bg-orange-600 hover:bg-orange-700' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {isSubmitting ? 'Guardando...' : (editingId ? 'Actualizar' : 'Guardar')}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="col-span-1 md:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b bg-gray-50 font-bold text-gray-700 flex justify-between"><span>Directorio</span><span className="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">{suppliers.length}</span></div>
                        <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white text-gray-500 border-b"><tr><th className="p-3">Empresa</th><th className="p-3">RUC</th><th className="p-3">Categor칤a</th><th className="p-3">Contacto</th><th className="p-3 text-right">Acciones</th></tr></thead><tbody className="divide-y divide-gray-100">{suppliers.map(s => (<tr key={s.id} className="hover:bg-gray-50"><td className="p-3 font-bold text-gray-800 flex items-center"><Icons.Building size={14} className="mr-2 text-gray-400"/>{s.name}</td><td className="p-3 font-mono text-xs">{s.ruc || '-'}</td><td className="p-3"><span className="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">{s.category}</span></td><td className="p-3 text-xs text-gray-500"><div>{s.contactName}</div><div className="flex items-center mt-1"><Icons.Phone size={10} className="mr-1"/>{s.phone}</div></td><td className="p-3 text-right flex justify-end gap-2"><button onClick={() => handleEdit(s)} className="text-blue-400 hover:text-blue-600 transition" title="Editar"><Icons.Edit size={16}/></button><button onClick={() => deleteSupplier(s.id)} className="text-gray-300 hover:text-red-500 transition"><Icons.Trash size={16}/></button></td></tr>))}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const Purchases = ({ db, userId, suppliers, products, purchasesList, transactionJump, onJumpHandled, showNotification }) => { 
            const [selectedSupplier, setSelectedSupplier] = React.useState('');
            const [purchaseDate, setPurchaseDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [dueDate, setDueDate] = React.useState(new Date().toISOString().split('T')[0]);
            const [items, setItems] = React.useState([]);
            const [itemProd, setItemProd] = React.useState('');
            const [itemQty, setItemQty] = React.useState(1);
            const [itemCost, setItemCost] = React.useState(0);
            const [invoiceNo, setInvoiceNo] = React.useState('');
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [deletingId, setDeletingId] = React.useState(null);
            const [editingId, setEditingId] = React.useState(null);
            const [originalItems, setOriginalItems] = React.useState([]);
            const [viewingPurchase, setViewingPurchase] = React.useState(null);

            React.useEffect(() => {
                if (transactionJump && transactionJump.type === 'purchase' && purchasesList.length > 0) {
                    const targetPurchase = purchasesList.find(p => p.id === transactionJump.id);
                    if (targetPurchase) {
                        setViewingPurchase(targetPurchase);
                        onJumpHandled();
                    }
                }
            }, [transactionJump, purchasesList]);

            // --- L칍GICA DE CR칄DITO INTELIGENTE ---
            React.useEffect(() => {
                if (editingId) return;
                if (selectedSupplier && purchaseDate) {
                    const supplier = suppliers.find(s => s.id === selectedSupplier);
                    if (supplier) {
                        const name = supplier.name.toUpperCase();
                        const ruc = supplier.ruc || '';
                        // Detectar proveedores de cr칠dito 15 d칤as
                        const isSpecialCredit = name.includes("DISTRIBUCIONES P & D") || ruc.includes("20492967468") || name.includes("DISPLASVAL") || ruc.includes("20380490545");

                        if (isSpecialCredit) {
                            const [y, m, d] = purchaseDate.split('-').map(Number);
                            if (d <= 15) {
                                // Compra del 1 al 15 -> Paga el 16
                                setDueDate(`${y}-${String(m).padStart(2, '0')}-16`);
                            } else {
                                // Compra del 16 al fin -> Paga el 1 del sig mes
                                const nextMonthDate = new Date(y, m, 1);
                                const nm = String(nextMonthDate.getMonth() + 1).padStart(2, '0');
                                const ny = nextMonthDate.getFullYear();
                                setDueDate(`${ny}-${nm}-01`);
                            }
                        } else {
                            setDueDate(purchaseDate);
                        }
                    }
                }
            }, [selectedSupplier, purchaseDate, suppliers, editingId]);

            const handleProductSelect = (pid) => { 
                setItemProd(pid); 
                if (pid) { 
                    const prod = products.find(p => p.id === pid); 
                    if (prod) setItemCost(prod.cost); 
                } else {
                    setItemCost(0);
                }
            };

            const addItem = () => { if (!itemProd || itemQty <= 0 || itemCost < 0) return; const prod = products.find(p => p.id === itemProd); setItems([...items, { productId: prod.id, productName: prod.name, qty: parseInt(itemQty), cost: parseFloat(itemCost), subtotal: parseInt(itemQty) * parseFloat(itemCost) }]); setItemProd(''); setItemQty(1); setItemCost(0); };
            
            const handleEdit = (purchase) => { 
                setSelectedSupplier(purchase.supplierId); 
                setPurchaseDate(purchase.date); 
                setDueDate(purchase.dueDate || purchase.date); 
                setInvoiceNo(purchase.invoiceNo); 
                setItems(purchase.items); 
                setEditingId(purchase.id); 
                setOriginalItems(purchase.items); 
            };
            
            const cancelEdit = () => { setEditingId(null); setOriginalItems([]); setItems([]); setSelectedSupplier(''); setInvoiceNo(''); setPurchaseDate(new Date().toISOString().split('T')[0]); setDueDate(new Date().toISOString().split('T')[0]); };

            const savePurchase = async () => {
                if (!selectedSupplier) { showNotification("丘멆잺 Seleccionar proveedor.", 'error'); return; }
                if (items.length === 0) { showNotification("丘멆잺 Lista vac칤a.", 'error'); return; }
                setIsSubmitting(true);
                const supplier = suppliers.find(s => s.id === selectedSupplier);
                
                const total = items.reduce((a, b) => a + b.subtotal, 0);
                try {
                    const timestamp = new Date().toISOString();
                    const purchasePayload = { 
                        supplierId: selectedSupplier, 
                        supplierName: supplier.name, 
                        date: purchaseDate, 
                        dueDate: dueDate, 
                        invoiceNo, 
                        items, 
                        total, 
                        status: 'Pendiente', // Default
                        createdAt: Timestamp.now() 
                    };
                    
                    if (editingId) {
                        for (let item of originalItems) {
                            const prodRef = doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId);
                            const prodSnap = await getDoc(prodRef);
                            if(prodSnap.exists()) { const currentData = prodSnap.data(); const revertedStock = Math.max(0, (currentData.stock || 0) - item.qty); await updateDoc(prodRef, { stock: revertedStock }); }
                        }
                        for (let item of items) {
                            const prod = products.find(p => p.id === item.productId);
                            if(prod) {
                                const currentData = (await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId))).data();
                                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId), { stock: (currentData.stock || 0) + item.qty });
                            }
                        }
                        
                        const originalPurchase = purchasesList.find(p => p.id === editingId);
                        purchasePayload.status = originalPurchase?.status || 'Pendiente'; // Mantener estado
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'purchases', editingId), purchasePayload);
                        setEditingId(null); setOriginalItems([]);
                        showNotification("Compra actualizada.", 'success');
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'purchases'), purchasePayload);

                        // --- L칍GICA CPP AL GUARDAR NUEVA ---
                        for (let item of items) { 
                            const prod = products.find(p => p.id === item.productId); 
                            if (prod) { 
                                const currentStock = prod.stock || 0;
                                const currentCost = prod.cost || 0;
                                const incomingQty = item.qty;
                                const incomingCost = item.cost;
                                const totalValueOld = currentStock * currentCost;
                                const totalValueNew = incomingQty * incomingCost;
                                const newTotalStock = currentStock + incomingQty;
                                let newWeightedCost = 0;
                                if (newTotalStock > 0) newWeightedCost = (totalValueOld + totalValueNew) / newTotalStock;

                                await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', prod.id), { 
                                    stock: newTotalStock, 
                                    cost: newWeightedCost, 
                                    priceHistory: arrayUnion({ date: purchaseDate || timestamp, cost: newWeightedCost, price: prod.price, source: 'Compra (CPP)', note: `Fac. ${invoiceNo}` }) 
                                }); 
                            }
                        }
                        showNotification("Compra registrada (CPP Actualizado).", 'success');
                    }
                    setItems([]); setSelectedSupplier(''); setInvoiceNo(''); 
                } catch (e) { console.error(e); showNotification("Error al guardar.", 'error'); } 
                finally { setIsSubmitting(false); }
            };

            const markPurchaseAsPaid = async (purchase) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'purchases', purchase.id), { status: 'Pagado' });
                    showNotification("Factura marcada como PAGADA.", 'success');
                } catch (e) { showNotification("Error al actualizar estado.", 'error'); }
            };

            const markPurchaseAsPending = async (purchase) => {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'purchases', purchase.id), { status: 'Pendiente' });
                    showNotification("Factura revertida a PENDIENTE.", 'success');
                } catch (e) { showNotification("Error al actualizar estado.", 'error'); }
            };

            const handleDelete = async (purchase) => {
                setDeletingId(purchase.id);
                try {
                    for (let item of purchase.items) {
                        const prodRef = doc(db, 'artifacts', appId, 'users', userId, 'products', item.productId);
                        const prodSnap = await getDoc(prodRef);
                        if(prodSnap.exists()) { const currentData = prodSnap.data(); const newStock = Math.max(0, (currentData.stock || 0) - item.qty); await updateDoc(prodRef, { stock: newStock }); }
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'purchases', purchase.id));
                    showNotification("Compra anulada.", 'success');
                } catch(e) { console.error(e); showNotification("Error al anular.", 'error'); } finally { setDeletingId(null); }
            };

            const getDaysRemaining = (dueStr) => {
                if (!dueStr) return null;
                const [y, m, d] = dueStr.split('-').map(Number);
                const due = new Date(y, m - 1, d);
                const today = new Date();
                today.setHours(0,0,0,0);
                const diffTime = due - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            };

            return (
                <div className="animate-fade-in grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
                    {/* ... (Modal de vista previa se mantiene igual) ... */}
                    {viewingPurchase && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4" onClick={() => setViewingPurchase(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 className="font-bold text-gray-800 flex items-center"><Icons.ShoppingBag size={18} className="mr-2 text-orange-600"/> Detalle de Factura</h3><button onClick={() => setViewingPurchase(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button></div>
                                <div className="p-6">
                                    <div className="grid grid-cols-2 gap-4 mb-6"><div><span className="block text-xs text-gray-500 uppercase font-bold">Proveedor</span><span className="text-sm font-medium text-gray-800">{viewingPurchase.supplierName}</span></div><div><span className="block text-xs text-gray-500 uppercase font-bold">Fecha Emisi칩n</span><span className="text-sm font-medium text-gray-800">{formatDate(viewingPurchase.date)}</span></div><div><span className="block text-xs text-gray-500 uppercase font-bold">Fecha Pago</span><span className="text-sm font-medium text-red-600">{formatDate(viewingPurchase.dueDate || viewingPurchase.date)}</span></div><div><span className="block text-xs text-gray-500 uppercase font-bold">N춿 Factura</span><span className="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">{viewingPurchase.invoiceNo || 'S/N'}</span></div></div>
                                    <div className="border rounded-lg overflow-hidden"><table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-600 text-xs uppercase border-b"><tr><th className="p-3">Producto</th><th className="p-3 text-center">Cant.</th><th className="p-3 text-right">Costo U.</th><th className="p-3 text-right">Subtotal</th></tr></thead><tbody className="divide-y divide-gray-100">{viewingPurchase.items.map((item, idx) => (<tr key={idx}><td className="p-3 text-gray-800">{item.productName}</td><td className="p-3 text-center text-gray-600">{item.qty}</td><td className="p-3 text-right text-gray-600">{formatCurrency(item.cost)}</td><td className="p-3 text-right font-medium text-gray-800">{formatCurrency(item.subtotal)}</td></tr>))}</tbody></table></div>
                                    
                                    {/* DESGLOSE FINANCIERO */}
                                    <div className="text-right text-xs text-gray-500 space-y-1 pt-2 border-t border-gray-100">
                                            <p>Base Imponible: <span className="font-medium text-gray-700">{formatCurrency(viewingPurchase.total)}</span></p>
                                            <p>IGV (18%): <span className="font-medium text-gray-700">{formatCurrency(viewingPurchase.total * 0.18)}</span></p>
                                            <p className="text-sm font-bold text-orange-600 mt-1 pt-1 border-t border-gray-50">Total a Pagar: {formatCurrency(viewingPurchase.total * 1.18)}</p>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex justify-end"><button onClick={() => setViewingPurchase(null)} className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition">Cerrar</button></div>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-orange-100 h-fit">
                        {/* ... (Formulario de Compra se mantiene igual) ... */}
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-orange-800 flex items-center"><Icons.ShoppingBag className="mr-2" size={20}/> {editingId ? 'Editar Compra' : 'Entrada de Mercader칤a (CPP)'}</h3>{editingId && <button onClick={cancelEdit} className="text-xs text-gray-500 hover:text-red-500">Cancelar</button>}</div>
                        <div className="space-y-3 mb-4">
                            <select className="w-full border p-2 rounded text-sm" value={selectedSupplier} onChange={e=>setSelectedSupplier(e.target.value)}><option value="">Proveedor</option>{suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                            <div className="flex gap-2">
                                <div className="w-1/2">
                                    <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">F. Emisi칩n</label>
                                    <input type="date" className="w-full border p-2 rounded text-sm" value={purchaseDate} onChange={e=>setPurchaseDate(e.target.value)} />
                                </div>
                                <div className="w-1/2">
                                    <label className="text-[10px] font-bold text-gray-500 uppercase block mb-1">F. Pago</label>
                                    <input type="date" className="w-full border p-2 rounded text-sm border-orange-200 bg-orange-50 text-orange-800 font-medium" value={dueDate} onChange={e=>setDueDate(e.target.value)} />
                                </div>
                            </div>
                            <div><input className="w-full border p-2 rounded text-sm" placeholder="N춿 Factura" value={invoiceNo} onChange={e=>setInvoiceNo(e.target.value)} /></div>
                        </div>
                        <div className="bg-orange-50 p-3 rounded-lg mb-3 border border-orange-200">
                            <div className="mb-2"><label className="text-xs text-gray-500 font-bold mb-1 block">BUSCAR PRODUCTO</label><SmartProductSelect products={products} value={itemProd} onChange={handleProductSelect} /></div>
                            <div className="flex gap-2"><input type="number" className="w-1/3 border p-1 rounded text-sm" placeholder="Cant." value={itemQty} onChange={e=>setItemQty(e.target.value)} /><div className="w-1/3 relative"><input type="number" className="w-full border p-1 rounded text-sm pl-4" placeholder="Costo Base" value={itemCost} onChange={e=>setItemCost(e.target.value)} /><span className="absolute left-1 top-1 text-gray-400 text-xs">S/</span></div><button onClick={addItem} className="w-1/3 bg-orange-600 text-white rounded text-xs font-bold hover:bg-orange-700">Add</button></div>
                            <p className="text-[10px] text-orange-600 mt-1">* Ingresar Costo Unitario SIN IGV</p>
                        </div>
                        {items.length > 0 && <div className="mb-3 text-xs border-t pt-2"><div className="font-bold text-right mb-1">Total Neto: {formatCurrency(items.reduce((a,b)=>a+b.subtotal,0))}</div>{items.map((it, idx) => <div key={idx} className="flex justify-between text-gray-600"><span>{it.qty} x {it.productName}</span><span>{formatCurrency(it.subtotal)}</span></div>)}</div>}
                        <button onClick={savePurchase} disabled={isSubmitting} className={`w-full text-white py-2 rounded font-bold disabled:opacity-50 transition ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}>{isSubmitting ? 'Procesando...' : (editingId ? 'Actualizar Compra' : 'Confirmar Compra')}</button>
                    </div>
                    <div className="col-span-1 lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="p-4 border-b bg-gray-50 font-bold text-gray-700">Historial de Compras</div>
                        <div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white text-gray-500 border-b">
                            <tr>
                                <th className="p-3">Proveedor</th>
                                <th className="p-3 text-center">F. Pago / Estado</th>
                                <th className="p-3 text-right">Total (Inc. IGV)</th>
                                <th className="p-3 text-right">Acci칩n</th>
                            </tr>
                        </thead><tbody className="divide-y divide-gray-100">{purchasesList.map(p => {
                            const status = p.status || 'Pendiente';
                            const daysLeft = getDaysRemaining(p.dueDate || p.date);
                            const isLate = daysLeft < 0;
                            const isToday = daysLeft === 0;
                            const grossTotal = (p.total || 0) * 1.18; // Calculamos el Bruto para mostrar

                            return (
                                <tr key={p.id} className="hover:bg-gray-50">
                                    <td className="p-3">
                                        <div className="font-medium text-gray-800">{p.supplierName}</div>
                                        <div className="text-xs text-gray-400 font-mono">{p.invoiceNo || 'S/N'}  {formatDate(p.date)}</div>
                                    </td>
                                    <td className="p-3 text-center">
                                        {status === 'Pagado' ? (
                                            <span className="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold border border-green-200">PAGADO</span>
                                        ) : (
                                            <div className="flex flex-col items-center">
                                                <span className="text-xs font-bold text-gray-700 mb-1">{formatDate(p.dueDate || p.date)}</span>
                                                <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${isLate ? 'bg-red-100 text-red-700' : isToday ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                    {isLate ? `Vencido hace ${Math.abs(daysLeft)} d칤as` : isToday ? 'Vence HOY' : `Vence en ${daysLeft} d칤as`}
                                                </span>
                                            </div>
                                        )}
                                    </td>
                                    <td className="p-3 text-right font-bold text-gray-800">{formatCurrency(grossTotal)}</td>
                                    <td className="p-3 text-right flex justify-end items-center gap-2">
                                            {status === 'Pendiente' ? (
                                                <button onClick={() => markPurchaseAsPaid(p)} className="bg-green-50 text-green-600 p-1.5 rounded hover:bg-green-100 transition" title="Marcar como Pagado"><Icons.Check size={16}/></button>
                                            ) : (
                                                <button onClick={() => markPurchaseAsPending(p)} className="bg-gray-50 text-gray-400 p-1.5 rounded hover:bg-gray-100 hover:text-orange-500 transition" title="Revertir a Pendiente"><Icons.Clock size={16}/></button>
                                            )}
                                            <button onClick={() => setViewingPurchase(p)} className="text-gray-400 hover:text-indigo-500 transition" title="Ver"><Icons.Eye size={16}/></button>
                                            <button onClick={() => handleEdit(p)} disabled={!!editingId} className="text-gray-400 hover:text-blue-500 transition disabled:opacity-30" title="Editar"><Icons.Edit size={16}/></button>
                                            <button onClick={() => handleDelete(p)} disabled={deletingId === p.id || !!editingId} className="text-gray-400 hover:text-red-500 transition disabled:opacity-30" title="Anular"><Icons.Trash size={16}/></button>
                                    </td>
                                </tr>
                            );
                        })}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const Inventory = ({ db, userId, products, suppliers, salesList, purchasesList, onNavigateToTransaction, showNotification }) => { 
            const [newProdName, setNewProdName] = React.useState('');
            const [newProdCost, setNewProdCost] = React.useState('');
            const [newProdPrice, setNewProdPrice] = React.useState('');
            const [newProdStock, setNewProdStock] = React.useState('');
            const [newProdSupplier, setNewProdSupplier] = React.useState('');
            const [newProdCategory, setNewProdCategory] = React.useState('Abarrotes');
            
            const [isSubmitting, setIsSubmitting] = React.useState(false);
            const [editingId, setEditingId] = React.useState(null); 
            const [viewHistory, setViewHistory] = React.useState(null); 
            const [historyData, setHistoryData] = React.useState([]);
            const [filterType, setFilterType] = React.useState('all');
            const [adjustingProd, setAdjustingProd] = React.useState(null);
            const [adjStock, setAdjStock] = React.useState('');
            const [adjReason, setAdjReason] = React.useState('');
            const [searchTerm, setSearchTerm] = React.useState('');
            const [sortConfig, setSortConfig] = React.useState({ key: 'name', direction: 'asc' });
            
            const [showArchived, setShowArchived] = React.useState(false);

            const [previewTrans, setPreviewTrans] = React.useState(null);

            const productCategories = ["Abarrotes", "Limpieza", "Descartables", "Bebidas", "칔tiles de Escritorio", "L치cteos", "Embutidos", "Otros"];

            const processedProducts = React.useMemo(() => {
                let items = [...products];
                
                if (showArchived) {
                    items = items.filter(p => p.status === 'inactive');
                } else {
                    items = items.filter(p => p.status !== 'inactive'); 
                }

                if (searchTerm) { const lowerTerm = searchTerm.toLowerCase(); items = items.filter(p => p.name.toLowerCase().includes(lowerTerm) || (p.category || '').toLowerCase().includes(lowerTerm)); }
                
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        let aVal = a[sortConfig.key]; let bVal = b[sortConfig.key];
                        if (sortConfig.key === 'category') { aVal = aVal || 'ZZZ'; bVal = bVal || 'ZZZ'; }
                        if (sortConfig.key === 'margin') { aVal = a.price > 0 ? ((a.price - a.cost) / a.price) : 0; bVal = b.price > 0 ? ((b.price - b.cost) / b.price) : 0; }
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [products, searchTerm, sortConfig, showArchived]);

            const activeProducts = products.filter(p => p.status !== 'inactive');
            const globalInventoryValue = activeProducts.reduce((acc, p) => acc + ((p.cost || 0) * (p.stock || 0)), 0);
            const totalItems = activeProducts.reduce((acc, p) => acc + (p.stock || 0), 0);

            const requestSort = (key) => { let direction = 'asc'; if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc'; setSortConfig({ key, direction }); };
            const getSortIcon = (name) => { if (sortConfig.key !== name) return <div className="w-3 h-3 ml-1 opacity-20"><Icons.ArrowDown size={12}/></div>; return sortConfig.direction === 'asc' ? <Icons.ArrowUp size={12} className="ml-1"/> : <Icons.ArrowDown size={12} className="ml-1"/>; };

            const getTrend = (currentVal, history, type) => {
                if (!history || history.length === 0) return null;
                const sorted = [...history].sort((a,b) => new Date(b.date) - new Date(a.date));
                const prev = sorted.find(h => Math.abs(h[type] - currentVal) > 0.001);
                if (!prev) return null;
                const diff = currentVal - prev[type];
                const direction = diff > 0 ? 'up' : 'down';
                return { direction, diff: Math.abs(diff), prevValue: prev[type] };
            };
            const buildUnifiedHistory = (product) => {
                const combinedHistory = [];
                if (product.priceHistory) product.priceHistory.forEach(h => combinedHistory.push({...h, type: h.source === 'Ajuste' ? 'manual' : (h.type || 'manual')})); 
                purchasesList.forEach(pur => { pur.items.forEach(item => { if (item.productId === product.id) combinedHistory.push({ date: pur.date, cost: item.cost, price: product.price, source: 'Compra', note: `Factura ${pur.invoiceNo || 'S/N'}`, type: 'purchase', transactionId: pur.id }); }); });
                salesList.forEach(sale => { sale.items.forEach(item => { if (item.productId === product.id) combinedHistory.push({ date: sale.date, cost: product.cost, price: item.price, source: 'Venta', note: `Cliente: ${sale.clientName}`, type: 'sale', transactionId: sale.id }); }); });
                return combinedHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            };
            const processHistoryForTrends = (rawHistory) => {
                 const sortedAsc = [...rawHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
                 let lastCost = null; let lastPrice = null;
                 const filtered = sortedAsc.filter(item => {
                     const isDifferent = (a, b) => Math.abs(a - b) > 0.001; 
                     if (item.type === 'purchase') { if (lastCost === null || isDifferent(item.cost, lastCost)) { lastCost = item.cost; return true; } return false; } 
                     else if (item.type === 'sale') { if (lastPrice === null || isDifferent(item.price, lastPrice)) { lastPrice = item.price; return true; } return false; }
                     return true; 
                 });
                 return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            };
            const handleViewHistoryClick = (prod) => { const unified = buildUnifiedHistory(prod); const optimized = processHistoryForTrends(unified); setHistoryData(optimized); setViewHistory(prod); setFilterType('all'); };
            const filteredHistory = historyData.filter(h => { if (filterType === 'all') return true; return h.type === filterType; });
            
            const handleOpenPreview = (type, id) => {
                let docData = null;
                if (type === 'sale') docData = salesList.find(s => s.id === id);
                else if (type === 'purchase') docData = purchasesList.find(p => p.id === id);
                
                if (docData) {
                    setPreviewTrans({ type, data: docData });
                } else {
                    showNotification("Documento no encontrado en el historial cargado.", 'error');
                }
            };

            const handleEdit = (prod) => { 
                setNewProdName(prod.name); 
                setNewProdCost(prod.cost); 
                setNewProdPrice(prod.price); 
                setNewProdStock(prod.stock); 
                setNewProdSupplier(prod.supplierId || '');
                setNewProdCategory(prod.category || 'Abarrotes');
                setEditingId(prod.id); 
            };
            
            const cancelEdit = () => { 
                setNewProdName(''); setNewProdCost(''); setNewProdPrice(''); setNewProdStock(''); setNewProdSupplier(''); 
                setNewProdCategory('Abarrotes'); 
                setEditingId(null); 
            };

            const saveProduct = async () => {
                if(!newProdName) return;
                setIsSubmitting(true);
                const costVal = parseFloat(newProdCost) || 0;
                const priceVal = parseFloat(newProdPrice) || 0;
                const productData = { 
                    name: newProdName, 
                    cost: costVal, 
                    price: priceVal, 
                    stock: parseInt(newProdStock) || 0, 
                    supplierId: newProdSupplier, 
                    category: newProdCategory, 
                    updatedAt: Timestamp.now(),
                    status: 'active'
                };
                try {
                    const timestamp = new Date().toISOString();
                    if (editingId) {
                        const oldProd = products.find(p => p.id === editingId);
                        if (oldProd && (oldProd.cost !== costVal || oldProd.price !== priceVal)) { 
                            productData.priceHistory = arrayUnion({ date: timestamp, cost: costVal, price: priceVal, source: 'Manual', note: 'Ajuste en Inventario', type: 'manual' }); 
                        }
                        productData.status = oldProd.status || 'active';
                        
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', editingId), productData);
                        showNotification("Producto actualizado.", 'success');
                    } else {
                        productData.createdAt = Timestamp.now();
                        productData.priceHistory = [{ date: timestamp, cost: costVal, price: priceVal, source: 'Manual', note: 'Creaci칩n Inicial', type: 'manual' }];
                        await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'products'), productData);
                        showNotification("Producto creado.", 'success');
                    }
                    cancelEdit();
                } catch(e) { console.error(e); showNotification("Error al guardar producto.", 'error'); } finally { setIsSubmitting(false); }
            };

            const toggleProductStatus = async (prod) => {
                const newStatus = prod.status === 'inactive' ? 'active' : 'inactive';
                const actionLabel = newStatus === 'active' ? 'restaurado' : 'descontinuado';
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', prod.id), { status: newStatus });
                    showNotification(`Producto ${actionLabel} correctamente.`, 'success');
                } catch (e) {
                    showNotification("Error al cambiar estado.", 'error');
                }
            };

            const deleteProduct = async (id) => { try { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'products', id)); showNotification("Producto eliminado.", 'success'); } catch(e) { showNotification("Error al eliminar.", 'error'); } };

            // --- NUEVA FUNCI칍N: EXPORTAR CAT츼LOGO EXCEL (PROFESIONAL) ---
            const handleExportClientCatalog = () => {
                if (products.length === 0) { showNotification("No hay productos para exportar.", 'error'); return; }

                // 1. Preparar datos para Excel
                // Encabezados con formato de t칤tulo
                const data = [
                    ["CAT츼LOGO DE PRODUCTOS - ENBEB MARKET"],
                    [`Fecha de Emisi칩n: ${new Date().toLocaleDateString()}`],
                    [""], // Fila en blanco
                    ["CATEGOR칈A", "PRODUCTO", "PRECIO UNIT. (S/ Inc. IGV)"]
                ];

                // 2. Ordenar por Categor칤a y Nombre
                const sortedForCatalog = [...products].sort((a, b) => {
                    const catA = (a.category || 'Otros').toLowerCase();
                    const catB = (b.category || 'Otros').toLowerCase();
                    if (catA < catB) return -1;
                    if (catA > catB) return 1;
                    return a.name.localeCompare(b.name);
                });

                // 3. Llenar filas con datos
                sortedForCatalog.forEach(p => {
                    // Solo exportar activos
                    if (p.status === 'inactive') return;
                    
                    data.push([
                        (p.category || 'Otros').toUpperCase(),
                        p.name,
                        // Precio con IGV calculado y formateado como n칰mero
                        parseFloat(((p.price || 0) * 1.18).toFixed(2)) 
                    ]);
                });

                // 4. Crear Libro y Hoja de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);

                // 5. Ajustar ancho de columnas para apariencia profesional
                const wscols = [
                    { wch: 25 }, // Ancho Categor칤a
                    { wch: 50 }, // Ancho Producto (m치s amplio)
                    { wch: 25 }  // Ancho Precio
                ];
                ws['!cols'] = wscols;

                // 6. A침adir hoja y descargar archivo .xlsx
                XLSX.utils.book_append_sheet(wb, ws, "Cat치logo");
                XLSX.writeFile(wb, `Catalogo_ENBEB_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showNotification("Cat치logo Excel generado exitosamente.", 'success');
            };

            return (
                <div className="animate-fade-in space-y-6 relative">
                    {previewTrans && (
                        <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 animate-fade-in" onClick={() => setPreviewTrans(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-800 flex items-center">
                                        {previewTrans.type === 'sale' ? <Icons.Cart size={18} className="mr-2 text-blue-600"/> : <Icons.ShoppingBag size={18} className="mr-2 text-orange-600"/>}
                                        {previewTrans.type === 'sale' ? 'Detalle de Venta' : 'Detalle de Compra'}
                                    </h3>
                                    <button onClick={() => setPreviewTrans(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[70vh]">
                                    {previewTrans.type === 'sale' ? (
                                        <>
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Cliente</span><span className="text-sm font-medium text-gray-800">{previewTrans.data.clientName}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Fecha</span><span className="text-sm font-medium text-gray-800">{formatDate(previewTrans.data.date)}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Estado</span><span className={`text-xs font-bold px-2 py-1 rounded ${previewTrans.data.status === 'Pagado' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}`}>{previewTrans.data.status}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Total</span><span className="text-lg font-bold text-blue-600">{formatCurrency(previewTrans.data.total)}</span></div>
                                            </div>
                                            <div className="border rounded-lg overflow-hidden">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-gray-50 text-gray-600 text-xs uppercase border-b"><tr><th className="p-3">Producto</th><th className="p-3 text-center">Cant.</th><th className="p-3 text-right">Precio</th><th className="p-3 text-right">Total</th></tr></thead>
                                                    <tbody className="divide-y divide-gray-100">
                                                        {previewTrans.data.items.map((item, idx) => (
                                                            <tr key={idx}><td className="p-3 text-gray-800">{item.productName}</td><td className="p-3 text-center">{item.qty}</td><td className="p-3 text-right">{formatCurrency(item.price)}</td><td className="p-3 text-right font-medium">{formatCurrency(item.subtotal)}</td></tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-2 gap-4 mb-6">
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Proveedor</span><span className="text-sm font-medium text-gray-800">{previewTrans.data.supplierName}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Fecha</span><span className="text-sm font-medium text-gray-800">{formatDate(previewTrans.data.date)}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Factura</span><span className="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">{previewTrans.data.invoiceNo || 'S/N'}</span></div>
                                                <div><span className="block text-xs text-gray-500 uppercase font-bold">Total</span><span className="text-lg font-bold text-green-600">{formatCurrency(previewTrans.data.total)}</span></div>
                                            </div>
                                            <div className="border rounded-lg overflow-hidden">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-gray-50 text-gray-600 text-xs uppercase border-b"><tr><th className="p-3">Producto</th><th className="p-3 text-center">Cant.</th><th className="p-3 text-right">Costo</th><th className="p-3 text-right">Total</th></tr></thead>
                                                    <tbody className="divide-y divide-gray-100">
                                                        {previewTrans.data.items.map((item, idx) => (
                                                            <tr key={idx}><td className="p-3 text-gray-800">{item.productName}</td><td className="p-3 text-center">{item.qty}</td><td className="p-3 text-right">{formatCurrency(item.cost)}</td><td className="p-3 text-right font-medium">{formatCurrency(item.subtotal)}</td></tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </>
                                    )}
                                </div>
                                <div className="p-4 bg-gray-50 border-t flex justify-end">
                                    <button onClick={() => setPreviewTrans(null)} className="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700 transition">Cerrar Vista</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {adjustingProd && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={() => setAdjustingProd(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 className="font-bold text-gray-800 flex items-center"><Icons.Clipboard size={18} className="mr-2 text-indigo-600"/> Ajustar Stock</h3><button onClick={() => setAdjustingProd(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button></div>
                                <div className="p-6 space-y-4">
                                    <div><p className="text-sm text-gray-500 mb-1">Producto</p><p className="font-bold text-gray-800">{adjustingProd.name}</p></div>
                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nuevo Stock Real</label><input type="number" className="w-full p-2 border rounded font-bold text-lg text-center" value={adjStock} onChange={e => setAdjStock(e.target.value)} autoFocus /><p className="text-xs text-center mt-1 text-gray-400">Stock actual: {adjustingProd.stock} ({parseInt(adjStock) - adjustingProd.stock > 0 ? '+' : ''}{parseInt(adjStock) - adjustingProd.stock || 0})</p></div>
                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Motivo</label><select className="w-full p-2 border rounded text-sm" value={adjReason} onChange={e => setAdjReason(e.target.value)}><option value="">Seleccionar motivo...</option><option value="Conteo F칤sico / Inventario">Conteo F칤sico</option><option value="Merma / Rotura">Merma / Rotura</option><option value="Regalo / Bonificaci칩n">Regalo / Bonificaci칩n</option><option value="Entrada sin Factura">Entrada sin Factura</option><option value="Error de Digitaci칩n">Error de Digitaci칩n</option></select></div>
                                    <button onClick={saveAdjustment} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">Guardar Ajuste</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {viewHistory && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in" onClick={() => setViewHistory(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><div><h3 className="font-bold text-gray-800">Historial de Transacciones (Kardex Simplificado)</h3><p className="text-xs text-gray-500">{viewHistory.name}</p></div><button onClick={() => setViewHistory(null)} className="text-gray-400 hover:text-gray-600"><Icons.X size={20}/></button></div>
                                <div className="flex border-b">{['all', 'sale', 'purchase', 'manual'].map(type => (<button key={type} onClick={() => setFilterType(type)} className={`flex-1 py-2 text-xs font-bold uppercase transition ${filterType === type ? 'bg-indigo-50 text-indigo-700 border-b-2 border-indigo-600' : 'text-gray-500 hover:bg-gray-50'}`}>{type === 'all' ? 'Todos' : (type === 'sale' ? 'Ventas' : (type === 'purchase' ? 'Compras' : 'Ajustes'))}</button>))}</div>
                                <div className="p-2 bg-yellow-50 text-xs text-yellow-700 border-b text-center">* Mostrando solo registros donde hubo cambio de precio/costo.</div>
                                <div className="p-0 overflow-y-auto max-h-96">
                                    <table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-600 text-xs uppercase border-b sticky top-0"><tr><th className="p-3">Fecha</th><th className="p-3">Tipo</th><th className="p-3 text-right">Valor</th><th className="p-3 text-right">Detalle / Acci칩n</th></tr></thead><tbody className="divide-y divide-gray-100">{filteredHistory.length > 0 ? (filteredHistory.map((h, idx) => (<tr key={idx} className="hover:bg-gray-50"><td className="p-3 text-xs text-gray-500">{formatDate(h.date)}</td><td className="p-3"><span className={`text-xs px-2 py-1 rounded-full font-bold ${h.source === 'Compra' ? 'bg-orange-100 text-orange-700' : h.source === 'Venta' ? 'bg-blue-100 text-blue-700' : h.source === 'Ajuste' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}`}>{h.source}</span></td><td className="p-3 text-right font-medium text-gray-800">{h.source === 'Compra' ? formatCurrency(h.cost) : (h.source === 'Venta' ? formatCurrency(h.price) : '-')}</td><td className="p-3 text-right text-xs text-gray-500">{h.transactionId ? (<button onClick={() => handleOpenPreview(h.type, h.transactionId)} className="text-indigo-600 hover:underline font-bold flex items-center justify-end w-full">VER DOC <Icons.Eye className="ml-1" size={14}/></button>) : (<span title={h.note} className="truncate max-w-[150px] block">{h.note}</span>)}</td></tr>))) : (<tr><td colSpan="4" className="p-6 text-center text-gray-400 text-xs">No hay cambios de precio registrados.</td></tr>)}</tbody></table>
                                </div>
                                <div className="p-3 bg-gray-50 border-t text-right"><button onClick={() => setViewHistory(null)} className="text-xs font-bold text-gray-500 hover:text-gray-800">Cerrar</button></div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 flex items-center justify-between">
                            <div>
                                <p className="text-xs text-indigo-500 font-bold uppercase tracking-wider">Valor Total Inventario</p>
                                <h3 className="text-2xl font-bold text-indigo-700">{formatCurrency(globalInventoryValue)}</h3>
                                <p className="text-xs text-indigo-400 mt-1">Activos Vendibles</p>
                            </div>
                            <div className="p-3 bg-indigo-50 rounded-full text-indigo-600"><Icons.Dollar size={24}/></div>
                        </div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-blue-100 flex items-center justify-between">
                            <div>
                                <p className="text-xs text-blue-500 font-bold uppercase tracking-wider">Total Unidades</p>
                                <h3 className="text-2xl font-bold text-blue-700">{totalItems}</h3>
                                <p className="text-xs text-blue-400 mt-1">Stock Activo</p>
                            </div>
                            <div className="p-3 bg-blue-50 rounded-full text-blue-600"><Icons.Package size={24}/></div>
                        </div>
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-purple-100 flex items-center justify-between">
                            <div>
                                <p className="text-xs text-purple-500 font-bold uppercase tracking-wider">Referencias (SKUs)</p>
                                <h3 className="text-2xl font-bold text-purple-700">{activeProducts.length}</h3>
                                <p className="text-xs text-purple-400 mt-1">Cat치logo Vigente</p>
                            </div>
                            <div className="p-3 bg-purple-50 rounded-full text-purple-600"><Icons.Clipboard size={24}/></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-1">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit lg:sticky lg:top-4">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex items-center text-gray-800"><Icons.Package size={20} className="mr-2 text-purple-600"/> {editingId ? 'Editar Producto' : 'Agregar Producto'}</h3>{editingId && <button onClick={cancelEdit} className="text-xs text-gray-500 hover:text-red-500 underline">Cancelar</button>}</div>
                                <div className="space-y-4">
                                    <div><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Nombre del Producto</label><input className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none transition-all" placeholder="Ej. Envase 1L" value={newProdName} onChange={e=>setNewProdName(e.target.value)} /></div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 uppercase block mb-1">Categor칤a</label>
                                        <select className="w-full border p-2 rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none" value={newProdCategory} onChange={e=>setNewProdCategory(e.target.value)}>
                                            {productCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Costo Neto (S/ IGV)</label><input className="w-full border p-2 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 outline-none" type="number" placeholder="0.00" value={newProdCost} onChange={e=>setNewProdCost(e.target.value)} /></div>
                                        <div className="w-1/2"><label className="text-xs font-bold text-gray-500 uppercase block mb-1">P. Base (S/ IGV)</label><input className="w-full border p-2 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-purple-500 outline-none" type="number" placeholder="0.00" value={newProdPrice} onChange={e=>setNewProdPrice(e.target.value)} /></div>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="w-1/3"><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Stock</label><input className="w-full border p-2 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none" type="number" placeholder="0" value={newProdStock} onChange={e=>setNewProdStock(e.target.value)} /></div>
                                        <div className="w-2/3"><label className="text-xs font-bold text-gray-500 uppercase block mb-1">Proveedor Principal</label><select className="w-full border p-2 rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none" value={newProdSupplier} onChange={e=>setNewProdSupplier(e.target.value)}><option value="">Seleccionar...</option>{suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                    </div>
                                    <button onClick={saveProduct} disabled={isSubmitting} className={`w-full text-white py-3 rounded-lg text-sm font-bold shadow-md hover:shadow-lg transition-all disabled:opacity-50 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'}`}>{isSubmitting ? 'Guardando...' : (editingId ? 'Actualizar Producto' : 'Guardar Producto')}</button>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                            <div className="p-4 border-b bg-gray-50 font-semibold text-gray-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div className="flex items-center">
                                    <span>{showArchived ? 'Productos Descontinuados' : 'Inventario Activo'}</span>
                                    <span className={`text-xs px-2 py-1 rounded-full ml-2 font-bold ${showArchived ? 'bg-gray-200 text-gray-700' : 'bg-purple-100 text-purple-800'}`}>{processedProducts.length} Items</span>
                                </div>
                                <div className="flex gap-2 w-full sm:w-auto items-center flex-wrap sm:flex-nowrap">
                                    <button 
                                        onClick={() => setShowArchived(!showArchived)}
                                        className={`text-xs font-bold px-3 py-2 rounded-lg border transition-colors flex items-center gap-1 ${showArchived ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}
                                    >
                                        {showArchived ? <Icons.ArrowUp size={14} className="rotate-180"/> : <Icons.Archive size={14}/>}
                                        {showArchived ? 'Ver Activos' : 'Ver Descontinuados'}
                                    </button>

                                    <div className="relative flex-1 sm:w-40"><input type="text" placeholder="Buscar..." className="w-full pl-8 pr-2 py-1.5 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-purple-200 outline-none transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><div className="absolute left-2.5 top-2 text-gray-400"><Icons.Search size={14} /></div></div>
                                    
                                    {!showArchived && (
                                        <button 
                                            onClick={handleExportClientCatalog} 
                                            className="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg shadow-sm transition-colors text-xs font-bold flex items-center gap-1"
                                            title="Descargar Cat치logo en Excel"
                                        >
                                            <Icons.Download size={16}/>
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="overflow-x-auto max-h-[600px]">
                                <table className="w-full text-left text-sm"><thead className="bg-white text-gray-500 border-b sticky top-0 z-10 shadow-sm text-xs uppercase font-bold tracking-wide">
                                    <tr>
                                            <th className="p-3">Producto</th>
                                            <th className="p-3">Cat.</th>
                                            <th className="p-3 text-center">Stock</th>
                                            <th className="p-3 text-right">Costo U.</th>
                                            {!showArchived && <th className="p-3 text-right bg-indigo-50 text-indigo-700 border-l border-indigo-100">Total</th>}
                                            <th className="p-3 text-right">P. Base</th>
                                            <th className="p-3 text-center">Margen</th>
                                            <th className="p-3 text-right">Acciones</th>
                                    </tr>
                                </thead><tbody className="divide-y divide-gray-100">{processedProducts.map(p => { 
                                    const margin = p.price ? ((p.price - p.cost)/p.price)*100 : 0; 
                                    const totalValue = (p.cost || 0) * (p.stock || 0);

                                    return (<tr key={p.id} className={`hover:bg-gray-50 transition group ${editingId === p.id ? 'bg-blue-50' : ''} ${p.status === 'inactive' ? 'bg-gray-50 opacity-70' : ''}`}>
                                            <td className="p-3 font-medium text-gray-800">{p.name}</td>
                                            <td className="p-3 text-xs text-gray-500">{p.category || '-'}</td>
                                            <td className="p-3 text-center"><span className={`px-2 py-0.5 rounded text-xs font-bold ${p.stock < 10 && p.status !== 'inactive' ? 'bg-red-100 text-red-700 ring-1 ring-red-200' : 'bg-gray-100 text-gray-700'}`}>{p.stock}</span></td>
                                            <td className="p-3 text-right text-gray-500 font-mono text-xs">{formatCurrency(p.cost)}</td>
                                            
                                            {!showArchived && <td className="p-3 text-right font-bold text-indigo-700 bg-indigo-50/30 border-l border-indigo-50">{formatCurrency(totalValue)}</td>}

                                            <td className="p-3 text-right text-gray-800 font-medium text-xs">{formatCurrency(p.price)}</td>
                                            <td className="p-3 text-center"><span className={`text-xs font-bold px-1.5 py-0.5 rounded ${margin < 20 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{margin.toFixed(0)}%</span></td>
                                            
                                            <td className="p-3 text-right">
                                                <div className="flex justify-end gap-1">
                                                    <button 
                                                        onClick={() => toggleProductStatus(p)} 
                                                        className={`p-1 rounded transition ${p.status === 'inactive' ? 'text-green-500 hover:bg-green-100' : 'text-gray-400 hover:text-gray-600 hover:bg-gray-200'}`}
                                                        title={p.status === 'inactive' ? "Restaurar Producto" : "Descontinuar/Archivar Producto"}
                                                    >
                                                        {p.status === 'inactive' ? <Icons.RefreshCw size={16} /> : <Icons.Archive size={16} />}
                                                    </button>

                                                    {p.status !== 'inactive' && (
                                                        <>
                                                            <button onClick={() => handleOpenAdjust(p)} className="p-1 hover:bg-orange-100 text-gray-400 hover:text-orange-600 rounded transition" title="Ajuste Stock"><Icons.Clipboard size={16} /></button>
                                                            <button onClick={() => handleViewHistoryClick(p)} className="p-1 hover:bg-purple-100 text-gray-400 hover:text-purple-600 rounded transition" title="Historial"><Icons.TrendingUp size={16} /></button>
                                                            <button onClick={() => handleEdit(p)} disabled={!!editingId && editingId !== p.id} className="p-1 hover:bg-blue-100 text-gray-400 hover:text-blue-600 rounded transition disabled:opacity-30" title="Editar"><Icons.Edit size={16} /></button>
                                                        </>
                                                    )}
                                                    
                                                    <button onClick={() => deleteProduct(p.id)} disabled={!!editingId} className="p-1 hover:bg-red-100 text-gray-400 hover:text-red-500 rounded transition disabled:opacity-30" title="Eliminar Definitivamente"><Icons.Trash size={16} /></button>
                                                </div>
                                            </td>
                                    </tr>) })}</tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const NavItem = ({ id, icon, label, activeTab, setActiveTab, setIsSidebarOpen }) => ( <button onClick={() => { setActiveTab(id); setIsSidebarOpen(false); }} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${activeTab === id ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}>{icon}<span className="font-medium text-sm">{label}</span></button> );

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(false); 
            const [transactionJump, setTransactionJump] = React.useState(null);
            const [notification, setNotification] = React.useState(null); 
            
            const [products, setProducts] = React.useState([]);
            const [sales, setSales] = React.useState([]);
            const [purchases, setPurchases] = React.useState([]); 
            const [clients, setClients] = React.useState([]);
            const [suppliers, setSuppliers] = React.useState([]);
            const [expenses, setExpenses] = React.useState([]);

            const showNotification = (message, type = 'success') => { setNotification({ message, type }); };

            React.useEffect(() => { const unsub = onAuthStateChanged(auth, u => { setUser(u); setLoading(false); }); return () => unsub(); }, []);
            React.useEffect(() => {
                if (!user) return;
                
                const safeSnapshot = (q, setter, name) => onSnapshot(q, 
                    (s) => setter(s.docs.map(d => ({id: d.id, ...d.data()}))),
                    (e) => { console.error(`Error fetching ${name}:`, e); } 
                );

                const unsubProds = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'products'), setProducts, 'products');
                const unsubSales = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'), setSales, 'sales');
                const unsubPurchases = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'purchases'), setPurchases, 'purchases');
                const unsubClients = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), setClients, 'clients');
                const unsubSuppliers = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'suppliers'), setSuppliers, 'suppliers');
                const unsubExpenses = safeSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), setExpenses, 'expenses');

                return () => { unsubProds(); unsubSales(); unsubPurchases(); unsubClients(); unsubSuppliers(); unsubExpenses(); }
            }, [user]);

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50"><div className="loader mr-3"></div><span className="text-gray-600 font-medium">Cargando sistema...</span></div>;
            if (!user) return <Login />;

            const handleLogout = async () => { try { await signOut(auth); } catch (error) { console.error("Error al cerrar sesi칩n", error); } };
            const handleJumpHandled = () => { setTransactionJump(null); };

            const sortedSales = [...sales].sort((a,b) => new Date(b.date) - new Date(a.date));
            const sortedPurchases = [...purchases].sort((a,b) => new Date(b.date) - new Date(a.date));
            const sortedExpenses = [...expenses].sort((a,b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="flex h-screen bg-gray-50 overflow-hidden">
                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={() => setIsSidebarOpen(false)}></div>}
                    <div className={`fixed inset-y-0 left-0 w-64 bg-slate-900 text-white flex flex-col shadow-2xl transform transition-transform duration-300 z-30 md:relative md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-6 border-b border-slate-800 flex justify-between items-center"><div><h1 className="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">ENBEB VISION</h1><p className="text-xs text-slate-500 mt-1">ERP & Analytics Pro</p></div><button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400"><Icons.X size={20}/></button></div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto hide-scrollbar">
                            <NavItem id="dashboard" icon={<Icons.Dashboard size={20}/>} label="Dashboard" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="sales" icon={<Icons.Cart size={20}/>} label="Ventas" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="purchases" icon={<Icons.ShoppingBag size={20}/>} label="Compras" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="inventory" icon={<Icons.Package size={20}/>} label="Inventario" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="expenses" icon={<Icons.Wallet size={20}/>} label="Gastos (OpEx)" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="reports" icon={<Icons.FileText size={20}/>} label="Reportes" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <div className="pt-6 pb-2 text-xs font-bold text-slate-600 uppercase tracking-wider">Directorios</div>
                            <NavItem id="clients" icon={<Icons.Users size={20}/>} label="Clientes" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                            <NavItem id="suppliers" icon={<Icons.Truck size={20}/>} label="Proveedores" activeTab={activeTab} setActiveTab={setActiveTab} setIsSidebarOpen={setIsSidebarOpen} />
                        </nav>
                        <div className="p-4 border-t border-slate-800"><button onClick={handleLogout} className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-red-900/20 hover:text-red-400 transition-all"><Icons.LogOut size={20}/><span className="font-medium text-sm">Cerrar Sesi칩n</span></button></div>
                        <div className="pb-4 bg-slate-900 text-xs text-slate-600 text-center">v4.0 Production</div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden w-full relative">
                        <header className="bg-white shadow-sm border-b sticky top-0 z-10 h-16 flex items-center px-4 justify-between">
                            <button onClick={() => setIsSidebarOpen(true)} className="md:hidden text-gray-600 p-2"><Icons.Menu size={24}/></button>
                            <h2 className="text-lg font-bold text-gray-800 capitalize ml-2 md:ml-0">{activeTab}</h2>
                            <div className="flex items-center space-x-3"><div className="text-right hidden sm:block"><p className="text-sm font-bold text-gray-800">ENBEB MARKET</p><p className="text-xs text-green-600 flex items-center justify-end"><span className="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Online</p></div><div className="h-9 w-9 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold" title={user.email}>{user.email.substring(0,2).toUpperCase()}</div></div>
                        </header>
                        <main className="flex-1 overflow-y-auto p-4 md:p-8 relative">
                            {activeTab === 'dashboard' && <Dashboard products={products} sales={sortedSales} purchases={sortedPurchases} expenses={sortedExpenses} />}
                            {activeTab === 'sales' && <Sales db={db} userId={user.uid} clients={clients} products={products} salesList={sortedSales} transactionJump={transactionJump} onJumpHandled={handleJumpHandled} showNotification={showNotification} />}
                            {activeTab === 'purchases' && <Purchases db={db} userId={user.uid} suppliers={suppliers} products={products} purchasesList={sortedPurchases} transactionJump={transactionJump} onJumpHandled={handleJumpHandled} showNotification={showNotification} />}
                            {activeTab === 'inventory' && <Inventory db={db} userId={user.uid} products={products} suppliers={suppliers} salesList={sortedSales} purchasesList={sortedPurchases} onNavigateToTransaction={()=>{}} showNotification={showNotification} />}
                            {activeTab === 'expenses' && <Expenses db={db} userId={user.uid} expenses={sortedExpenses} showNotification={showNotification} />}
                            {activeTab === 'reports' && <Reports products={products} sales={sortedSales} purchases={sortedPurchases} />}
                            {activeTab === 'clients' && <Clients db={db} userId={user.uid} clients={clients} showNotification={showNotification} />}
                            {activeTab === 'suppliers' && <Suppliers db={db} userId={user.uid} suppliers={suppliers} showNotification={showNotification} />}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>